/* =========================================
   SECTION 2: LOAD site-data.json + DRAFT
   ========================================= */

(async function loadSiteData() {
  try {
    const res = await fetch("site-data.json?cache-bust=" + Date.now());
    if (res.ok) {
      const data = await res.json();
      if (data && typeof data === "object") {
        // Merge, but let incoming site-data override defaults
        site = Object.assign({}, site, data);

        // Normalize pages: allow object or array in site-data.json
        if (data.pages) {
          if (Array.isArray(data.pages)) {
            site.pages = data.pages;
          } else if (typeof data.pages === "object") {
            site.pages = Object.keys(data.pages).map(key => {
              const p = data.pages[key] || {};
              return Object.assign(
                {
                  title: p.title || key,
                  slug: p.slug || key
                },
                p
              );
            });
          }
        }

        // Normalize menu to array
        if (data.menu && Array.isArray(data.menu)) {
          site.menu = data.menu;
        }
      }
    }
  } catch (e) {
    console.warn("Could not load site-data.json, using defaults", e);
  }

  // Restore local draft from this browser if any
  restoreDraftIfAny();

  // Initial render
  renderPages();
  updatePreviewHeader();
  renderPreview();
  applyPanelBehavior();
})();

/* DRAFT SAVE / RESTORE */
function saveDraft(){
  try{
    localStorage.setItem(DRAFT_KEY, JSON.stringify(site));
    markSavedLocal(); // reuse pill style
  } catch(e){
    alert("Could not save draft locally.");
  }
}
function restoreDraftIfAny(){
  try{
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(parsed && typeof parsed === "object") {
      site = Object.assign({}, site, parsed);
    }
  } catch(e){
    console.warn("No valid draft to restore");
  }
}
