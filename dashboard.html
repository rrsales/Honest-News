<script>
/* =======================
   STATE
======================= */

/*
  IMPORTANT:
  site-data.json is the single source of truth.
*/
let site = {
  menu: [],
  pages: [],
  theme: {},
  heroSlides: []
};

let current = null;
let isDirty = false;
let activeInspectorTab = "page";
const DRAFT_KEY = "hn_cms_draft_v1";

/* panel behavior: auto | manual | pinned | smart */
let panelBehavior = localStorage.getItem("hn_panel_behavior") || "auto";

const panel    = document.getElementById("inspectorPanel");
const handle   = document.getElementById("panelHandle");
const closeBtn = document.getElementById("closePanelBtn");
const saveStatusRight = document.getElementById("saveStatusRight");

/* Render Cloud endpoint */
const SAVE_ENDPOINT = "https://honest-news.onrender.com/save";

/* =======================
   LOAD site-data.json
======================= */
(async function loadSiteData() {
  let loadedFromServer = false;

  try {
    const res = await fetch("site-data.json?cache-bust=" + Date.now());
    if (res.ok) {
      const data = await res.json();
      if (data && typeof data === "object") {
        site = Object.assign({}, site, data);
        loadedFromServer = true;
      }
    }
  } catch (e) {
    console.warn("Could not load site-data.json, will try local draft instead", e);
  }

  if (!loadedFromServer) {
    restoreDraftIfAny();
  }

  renderPages();
  updatePreviewHeader();
  renderPreview();
  applyPanelBehavior();
  renderInspectorTab();
})();

/* =======================
   SAVE STATUS
======================= */
function markDirty(){
  isDirty = true;
  if (saveStatusRight){
    saveStatusRight.textContent = "Unsaved changes";
    saveStatusRight.classList.add("dirty");
    saveStatusRight.classList.remove("saved");
  }
}
function markSavedLocal(){
  isDirty = false;
  if (saveStatusRight){
    saveStatusRight.textContent = "Published";
    saveStatusRight.classList.remove("dirty");
    saveStatusRight.classList.add("saved");
  }
}

/* =======================
   LEFT SIDEBAR ACCORDION
======================= */
function toggleSidebarSection(which){
  const body    = document.getElementById(which + "Section");
  const chevron = document.getElementById(which + "Chevron");
  if (!body) return;

  const wasClosed = body.classList.contains("closed");

  // Close all
  document.querySelectorAll(".sidebar-section-body").forEach(el=>{
    el.classList.add("closed");
  });
  document.querySelectorAll(".sidebar-chevron").forEach(el=>{
    el.classList.remove("rotated");
  });

  // If it was closed, open it
  if (wasClosed){
    body.classList.remove("closed");
    if (chevron) chevron.classList.add("rotated");
  }
}

function openSidebarSection(which){
  const body    = document.getElementById(which + "Section");
  const chevron = document.getElementById(which + "Chevron");
  if (!body) return;

  document.querySelectorAll(".sidebar-section-body").forEach(el=>{
    el.classList.add("closed");
  });
  document.querySelectorAll(".sidebar-chevron").forEach(el=>{
    el.classList.remove("rotated");
  });

  body.classList.remove("closed");
  if (chevron) chevron.classList.add("rotated");
}

/* =======================
   PANEL BEHAVIOR + OPEN/CLOSE
======================= */
function isPanelOpen(){
  return panel.classList.contains("open");
}
function openPanel(reason){
  if (panelBehavior === "manual" && reason !== "manual") {
    return; // respect manual mode
  }
  panel.classList.add("open");
  handle.style.display = "none";
}
function closePanel(reason){
  if (panelBehavior === "pinned") {
    return; // pinned cannot close
  }
  panel.classList.remove("open");
  handle.style.display = "flex";
}
function togglePanelManual(){
  if (isPanelOpen()) closePanel("manual");
  else openPanel("manual");
}
function applyPanelBehavior(){
  if (panelBehavior === "pinned") {
    panel.classList.add("open");
    handle.style.display = "none";
  } else {
    handle.style.display = isPanelOpen() ? "none" : "flex";
  }
}

/* click handle to open manually */
handle.addEventListener("click", ()=>togglePanelManual());
closeBtn.addEventListener("click", ()=>closePanel("manual"));

/* keyboard shortcut: Shift+P toggles panel */
document.addEventListener("keydown", (e)=>{
  if(e.shiftKey && e.key.toLowerCase()==="p"){
    togglePanelManual();
  }
});

/* =======================
   SIDEBAR / PAGES
======================= */
function renderPages(){
  const container = document.getElementById("pages");
  const pagesArr = site.pages || [];

  if (!container) return;

  container.innerHTML = pagesArr.map((p,i)=>`
    <div class="page ${p===current?'active':''}" onclick="selectPage(${i})">
      <div class="page-main">
        <span class="title">${p.title || 'Untitled'}</span>
        <span class="slug">${p.slug || ''}</span>
      </div>
      <button class="page-delete-btn" title="Delete page"
        onclick="event.stopPropagation();deletePage(${i});">
        <i class="fa-regular fa-trash-can"></i>
      </button>
    </div>
  `).join("");

  rawFromMenu();
}

function newPage(){
  const t = prompt("Page title?");
  if (!t) return;
  const slug = t.toLowerCase().replace(/\s+/g,"-");
  if (!site.pages) site.pages = [];
  site.pages.push({
    title:t,
    slug,
    theme:"dark",
    hero:{
      bg:"",
      overlay:t,
      sub:"",
      transparentMenu:false,
      behavior:"still",
      size:"full",
      customHeight:""
    },
    blocks:[]
  });
  markDirty();
  renderPages();
  openSidebarSection("pages");
}

/* Delete page + remove from menu */
function deletePage(index){
  const page = (site.pages || [])[index];
  if (!page) return;

  if (!confirm(`Delete page "${page.title || page.slug || 'Untitled'}"?\nThis will also remove it from the navigation menu.`)) {
    return;
  }

  const slug = page.slug || "";
  const url1 = slug ? slug + ".html" : "";
  const url2 = slug;

  if (Array.isArray(site.menu)){
    site.menu = site.menu.filter(item =>
      item.url !== url1 && item.url !== url2
    );
  }

  site.pages.splice(index,1);
  if (current === page){
    current = site.pages[0] || null;
  }

  markDirty();
  renderPages();
  updatePreviewHeader();
  renderPreview();
  rawFromMenu();
}

/* =======================
   MENU EDITOR (RAW)
======================= */
function rawFromMenu(){
  const ta = document.getElementById("menuRaw");
  if(!ta) return;
  const menuArr = site.menu || [];
  ta.value = menuArr.map(m=>`${m.label || m.title || 'Item'} | ${m.url || "#"}`).join("\n");
}

function menuFromRaw(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  site.menu = lines.map((l,idx)=>{
    const [title,url] = l.split("|").map(s=>(s||"").trim());
    return {
      id: (title || "item-"+idx).toLowerCase().replace(/\s+/g,"-"),
      label: title || "Item",
      url: url || "#",
      type:"link",
      showOn:"both",
      subItems:[]
    };
  });
  markDirty();
}

/* =======================
   MENU EDITOR (GRAPHIC TAB)
======================= */
function ensureMenuArray(){
  if (!Array.isArray(site.menu)) {
    site.menu = [];
  }
}

function addMenuItem(){
  ensureMenuArray();
  const newItem = {
    id: "item-" + Date.now(),
    label: "New item",
    url: "#",
    type: "link",
    showOn: "both",
    subItems: []
  };
  site.menu.push(newItem);
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}

function removeMenuItem(index){
  ensureMenuArray();
  const item = site.menu[index];
  if (!item) return;
  if (!confirm(`Remove menu item "${item.label || item.title || 'Item'}"?`)) return;
  site.menu.splice(index,1);
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}

function moveMenuItem(i,d){
  ensureMenuArray();
  const arr = site.menu;
  const item = arr.splice(i,1)[0];
  let newIndex = i + d;
  if (newIndex < 0) newIndex = 0;
  if (newIndex > arr.length) newIndex = arr.length;
  arr.splice(newIndex,0,item);
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}

function changeMenuType(index,type){
  ensureMenuArray();
  const item = site.menu[index];
  if (!item) return;
  item.type = type;
  if (type === "mega" && !Array.isArray(item.subItems)) {
    item.subItems = [];
  }
  if (type !== "mega") {
    item.subItems = [];
  }
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}

function updateMenuField(index, field, value){
  ensureMenuArray();
  const item = site.menu[index];
  if (!item) return;

  if (field === "label") {
    item.label = value;
    // keep id loosely in sync on first edits (optional)
    if (!item.id || item.id.startsWith("item-")) {
      item.id = value.toLowerCase().replace(/\s+/g,"-") || ("item-"+index);
    }
  } else if (field === "url") {
    item.url = value;
  } else if (field === "showOn") {
    item.showOn = value;
  }

  markDirty();
  rawFromMenu();
}

function addSubItem(menuIndex){
  ensureMenuArray();
  const item = site.menu[menuIndex];
  if (!item) return;
  if (!Array.isArray(item.subItems)) item.subItems = [];
  item.subItems.push({
    label: "New link",
    url: "#",
    description: ""
  });
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}

function removeSubItem(menuIndex, subIndex){
  ensureMenuArray();
  const item = site.menu[menuIndex];
  if (!item || !Array.isArray(item.subItems)) return;
  item.subItems.splice(subIndex,1);
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}

function updateSubItemField(menuIndex, subIndex, field, value){
  ensureMenuArray();
  const item = site.menu[menuIndex];
  if (!item || !Array.isArray(item.subItems)) return;
  const sub = item.subItems[subIndex];
  if (!sub) return;

  if (field === "label") sub.label = value;
  else if (field === "url") sub.url = value;
  else if (field === "description") sub.description = value;

  markDirty();
  rawFromMenu();
}

/* =======================
   SELECT PAGE
======================= */
function selectPage(i){
  current = site.pages[i];
  renderPages();
  updatePreviewHeader();
  renderPreview();
  renderInspectorTab(); // refresh panel content
  if (panelBehavior === "auto" || panelBehavior === "pinned" || panelBehavior === "smart"){
    openPanel("auto");
  }
}

/* =======================
   PREVIEW
======================= */
function updatePreviewHeader(){
  const tEl = document.getElementById("previewPageTitle");
  const sEl = document.getElementById("previewPageSlug");
  const pl  = document.getElementById("panelPageLabel");
  if (!current){
    if (tEl) tEl.textContent = "No page selected";
    if (sEl) sEl.textContent = "";
    if (pl)  pl.textContent  = "No page selected";
    return;
  }
  if (tEl) tEl.textContent = current.title || "Untitled";
  if (sEl) sEl.textContent = current.slug || "";
  if (pl)  pl.textContent  = current.title + (current.slug ? ` (${current.slug})` : "");
}

function renderPreview(){
  const h = current && current.hero ? current.hero : {
    overlay:"Pick a page",
    sub:"Use the left bar to choose a page"
  };
  const heroDiv = document.getElementById("heroPreview");
  const titleEl = document.getElementById("heroPreviewInner").querySelector("h1");
  const subEl   = document.getElementById("heroPreviewInner").querySelector("p");

  titleEl.textContent = h.overlay || "";
  subEl.textContent   = h.sub || "";

  if (h.bg){
    heroDiv.style.backgroundImage = `url('${h.bg}')`;
  } else {
    heroDiv.style.backgroundImage = "none";
    heroDiv.style.backgroundColor = "#020617";
  }

  let height = "60vh";
  const size = h.size || "full";
  if(size==="small")  height="40vh";
  else if(size==="medium") height="60vh";
  else if(size==="large")  height="80vh";
  else if(size==="full")   height="100vh";
  else if(size==="custom" && h.customHeight) height = h.customHeight;
  heroDiv.style.height = height;

  const blocksEl = document.getElementById("blockPreview");
  const blocks = (current && current.blocks) ? current.blocks : [];
  let html = "";
  blocks.forEach(b=>{
    if(b.type==="heading"){
      html += `<h2 style="margin-top:1rem;color:#e5e7eb;font-size:1.1rem;">${escapeHtml(b.content || "")}</h2>`;
    } else if(b.type==="paragraph"){
      const text = (b.content || "").replace(/\n/g,"<br>");
      html += `<p style="margin-top:.4rem;color:#9ca3af;font-size:.9rem;">${text}</p>`;
    } else if(b.type==="image" && b.content){
      html += `<img src="${escapeHtml(b.content)}" style="max-width:100%;border-radius:12px;margin:1rem 0;">`;
    } else if(b.type==="button"){
      html += `<a href="${escapeHtml(b.url || '#')}"
        style="display:inline-block;margin:0.7rem 0;padding:0.6rem 1.6rem;border-radius:999px;background:var(--accent);color:#0b1120;text-decoration:none;font-weight:600;font-size:.88rem;">
        ${escapeHtml(b.text || "Learn more")}
      </a>`;
    } else if(b.type==="product"){
      html += `
        <div style="background:#020617;border-radius:14px;margin:0.8rem 0;padding:0.9rem;display:flex;gap:0.9rem;align-items:flex-start;border:1px solid rgba(55,65,81,.8);">
          ${b.image ? `<img src="${escapeHtml(b.image)}" style="width:110px;border-radius:10px;object-fit:cover;">` : ""}
          <div>
            <h3 style="margin:0 0 .3rem;font-size:.96rem;color:#e5e7eb;">${escapeHtml(b.title || "")}</h3>
            <p style="margin:0 0 .5rem;font-size:.8rem;color:#9ca3af;">${escapeHtml(b.text || "")}</p>
            ${b.url ? `<a href="${escapeHtml(b.url)}" target="_blank" rel="noopener noreferrer"
                style="display:inline-block;margin-top:0.2rem;padding:0.45rem 1.4rem;border-radius:999px;background:var(--accent);color:#0b1120;font-size:.8rem;font-weight:600;text-decoration:none;">
                Buy on Amazon
              </a>` : ""}
          </div>
        </div>
      `;
    } else if(b.type==="podcast" && b.embed){
      html += `
        <div style="margin:1.2rem 0;">
          <h3 style="margin:0 0 .3rem;color:#e5e7eb;">${escapeHtml(b.title || "")}</h3>
          <iframe src="${escapeHtml(b.embed)}"
            style="width:100%;height:150px;border:none;border-radius:10px;background:#0f172a;" allow="autoplay"></iframe>
        </div>
      `;
    } else if(b.type==="youtube" && b.videoId){
      let id = b.videoId.trim();
      const m = id.match(/v=([^&]+)/);
      if(m) id = m[1];
      html += `
        <div style="margin:1.2rem 0;">
          <h3 style="margin:0 0 .3rem;color:#e5e7eb;">${escapeHtml(b.title || "")}</h3>
          <div style="position:relative;padding-bottom:56.25%;height:0;border-radius:12px;overflow:hidden;">
            <iframe src="https://www.youtube.com/embed/${escapeHtml(id)}"
              style="position:absolute;top:0;left:0;width:100%;height:100%;border:none;"
              allowfullscreen></iframe>
          </div>
        </div>
      `;
    }
  });
  blocksEl.innerHTML = html;
}

/* DEVICE PREVIEW */
const previewFrame = document.getElementById("previewFrame");
document.querySelectorAll(".device-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const mode = btn.dataset.device;
    previewFrame.classList.remove("desktop","tablet","mobile");
    previewFrame.classList.add(mode);
    document.querySelectorAll(".device-btn").forEach(b=>{
      b.classList.toggle("active", b===btn);
    });
  });
});

/* =======================
   INSPECTOR TABS
======================= */
document.querySelectorAll(".inspect-tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    activeInspectorTab = tab.dataset.inspect;
    document.querySelectorAll(".inspect-tab").forEach(t=>{
      t.classList.toggle("active", t===tab);
    });
    renderInspectorTab();
    if (panelBehavior === "auto" || panelBehavior === "pinned" || panelBehavior === "smart"){
      openPanel("auto");
    }
  });
});

function renderInspectorTab(){
  const body = document.getElementById("inspectorBody");
  if (!current && activeInspectorTab!=="site" && activeInspectorTab!=="menu"){
    body.innerHTML = `<p style="color:#9ca3af;">Select a page on the left to edit.</p>`;
    return;
  }
  if (activeInspectorTab === "page"){
    body.innerHTML = renderPageTabHtml(current);
  } else if (activeInspectorTab === "hero"){
    body.innerHTML = renderHeroTabHtml(current);
  } else if (activeInspectorTab === "blocks"){
    body.innerHTML = renderBlocksTabHtml(current);
  } else if (activeInspectorTab === "menu"){
    body.innerHTML = renderMenuTabHtml();
  } else {
    body.innerHTML = renderSiteTabHtml();
    wirePanelBehaviorRadios();
  }
}

/* PAGE TAB */
function renderPageTabHtml(c){
  const themeLight = c.theme === "light";
  return `
    <div class="section">
      <div class="field-group">
        <div class="field-label">Title</div>
        <input type="text" value="${c.title || ''}"
          onchange="current.title=this.value;markDirty();renderPages();updatePreviewHeader();">
      </div>

      <div class="field-group">
        <div class="field-label">Slug</div>
        <input type="text" value="${c.slug || ''}"
          placeholder="home, about, podcast..."
          onchange="current.slug=this.value;markDirty();renderPages();updatePreviewHeader();">
        <div class="field-hint">
          Used by <code>data-page="slug"</code> in your HTML &lt;body&gt;.
        </div>
      </div>

      <div class="field-group">
        <div class="field-label">Theme</div>
        <label class="inline">
          <input type="radio" name="themeRadio" value="light" ${themeLight?'checked':''}
            onchange="current.theme='light';markDirty();">
          Light
        </label>
        <label class="inline">
          <input type="radio" name="themeRadio" value="dark" ${!themeLight?'checked':''}
            onchange="current.theme='dark';markDirty();">
          Dark
        </label>
      </div>
    </div>
  `;
}

/* HERO TAB */
function renderHeroTabHtml(c){
  const h = c.hero || {};
  const size = h.size || "full";
  const behavior = h.behavior || "still";

  return `
    <div class="section">
      <div class="field-group">
        <div class="field-label">Background image URL</div>
        <input type="url" value="${h.bg || ''}" placeholder="https://..."
          onchange="current.hero.bg=this.value;markDirty();renderPreview();">
      </div>

      <div class="field-group">
        <div class="field-label">Main title</div>
        <input type="text" value="${h.overlay || ''}" placeholder="Main hero title"
          onchange="current.hero.overlay=this.value;markDirty();renderPreview();">
      </div>

      <div class="field-group">
        <div class="field-label">Subtitle</div>
        <input type="text" value="${h.sub || ''}" placeholder="Optional subtitle"
          onchange="current.hero.sub=this.value;markDirty();renderPreview();">
      </div>

      <div class="field-group">
        <label class="inline">
          <input type="checkbox" ${h.transparentMenu ? "checked" : "" }
            onchange="current.hero.transparentMenu=this.checked;markDirty();">
          Transparent header on this page
        </label>
      </div>

      <div class="field-group">
        <div class="field-label">Hero behavior</div>
        <select onchange="current.hero.behavior=this.value;markDirty();">
          <option value="still" ${behavior==='still'?'selected':''}>Still image</option>
          <option value="parallax-slow" ${behavior==='parallax-slow'?'selected':''}>Parallax – slow</option>
          <option value="parallax-medium" ${behavior==='parallax-medium'?'selected':''}>Parallax – medium</option>
          <option value="float-up" ${behavior==='float-up'?'selected':''}>Float up</option>
        </select>
      </div>

      <div class="field-group">
        <div class="field-label">Hero height</div>
        <label class="inline">
          <input type="radio" name="heroSize" value="small" ${size==="small"?'checked':''}
            onchange="setHeroSize('small')">
          Small (≈40vh)
        </label><br>
        <label class="inline">
          <input type="radio" name="heroSize" value="medium" ${size==="medium"?'checked':''}
            onchange="setHeroSize('medium')">
          Medium (≈60vh)
        </label><br>
        <label class="inline">
          <input type="radio" name="heroSize" value="large" ${size==="large"?'checked':''}
            onchange="setHeroSize('large')">
          Large (≈80vh)
        </label><br>
        <label class="inline">
          <input type="radio" name="heroSize" value="full" ${size==="full"?'checked':''}
            onchange="setHeroSize('full')">
          Fullscreen (100vh)
        </label><br>
        <label class="inline">
          <input type="radio" name="heroSize" value="custom" ${size==="custom"?'checked':''}
            onchange="setHeroSize('custom')">
          Custom:
        </label>
        <input type="text" value="${h.customHeight || ''}" placeholder="e.g. 520px or 80vh"
          onchange="setHeroCustom(this.value)">
        <div class="field-hint">Custom height lets you match Podbean-style heroes exactly.</div>
      </div>
    </div>
  `;
}

function setHeroSize(size){
  if (!current.hero) current.hero = {};
  current.hero.size = size;
  markDirty();
  renderPreview();
}
function setHeroCustom(val){
  if (!current.hero) current.hero = {};
  current.hero.size = "custom";
  current.hero.customHeight = val.trim();
  markDirty();
  renderPreview();
}

/* BLOCKS TAB */
function renderBlocksTabHtml(c){
  const blocks = c.blocks || [];
  let html = `
    <div class="panelSection">
      <div class="panelLabel">Add blocks</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">
        <button class="btn secondary" type="button" onclick="addBlock('heading')">+ Heading</button>
        <button class="btn secondary" type="button" onclick="addBlock('paragraph')">+ Paragraph</button>
        <button class="btn secondary" type="button" onclick="addBlock('image')">+ Image</button>
        <button class="btn secondary" type="button" onclick="addBlock('button')">+ Button</button>
        <button class="btn secondary" type="button" onclick="addBlock('product')">+ Amazon product</button>
        <button class="btn secondary" type="button" onclick="addBlock('podcast')">+ Podcast</button>
        <button class="btn secondary" type="button" onclick="addBlock('youtube')">+ YouTube</button>
      </div>
    </div>
    <div class="panelSection">
  `;
  blocks.forEach((b,i)=>{
    const motion = b.motion || "fade";
    html += `
      <div class="block">
        <div class="block-header-line">
          <span class="block-type">${b.type.toUpperCase()}</span>
          <span>
            Motion:
            <select class="motion-select"
              onchange="current.blocks[${i}].motion=this.value;markDirty();renderPreview();">
              <option value="none"  ${motion==='none'?'selected':''}>None</option>
              <option value="fade"  ${motion==='fade'?'selected':''}>Fade</option>
              <option value="float" ${motion==='float'?'selected':''}>Float</option>
              <option value="slide" ${motion==='slide'?'selected':''}>Slide</option>
            </select>
          </span>
        </div>
        ${renderBlockFields(b,i)}
        <div class="tools">
          <button onclick="moveBlock(${i},-1)">↑</button>
          <button onclick="moveBlock(${i},1)">↓</button>
          <button onclick="removeBlock(${i})">×</button>
        </div>
      </div>
    `;
  });
  html += `</div>`;
  return html;
}

function renderBlockFields(b,i){
  if (b.type==="heading"){
    return `
      <div class="field-group">
        <div class="field-label">Text</div>
        <input type="text" value="${b.content || ''}"
          onchange="current.blocks[${i}].content=this.value;markDirty();renderPreview();">
      </div>
    `;
  }
  if (b.type==="paragraph"){
    return `
      <div class="field-group">
        <div class="field-label">Text</div>
        <textarea rows="4"
          onchange="current.blocks[${i}].content=this.value;markDirty();renderPreview();">${b.content || ''}</textarea>
      </div>
    `;
  }
  if (b.type==="image"){
    const mode = b.mode==="upload" ? "upload" : "url";
    return `
      <div class="field-group">
        <div class="field-label">Image source</div>
        <select onchange="current.blocks[${i}].mode=this.value;markDirty();renderInspectorTab();">
          <option value="url" ${mode==='url'?'selected':''}>URL</option>
          <option value="upload" ${mode==='upload'?'selected':''}>Upload</option>
        </select>
      </div>
      ${
        mode==="upload"
        ? `<input type="file" accept="image/*" onchange="handleImageUpload(event,${i})">`
        : `
          <div class="field-group">
            <div class="field-label">Image URL</div>
            <input type="url" value="${b.content || ''}"
              onchange="current.blocks[${i}].content=this.value;markDirty();renderPreview();">
          </div>`
      }
    `;
  }
  if (b.type==="button"){
    return `
      <div class="field-group">
        <div class="field-label">Button text</div>
        <input type="text" value="${b.text || ''}"
          onchange="current.blocks[${i}].text=this.value;markDirty();renderPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">Button URL</div>
        <input type="url" value="${b.url || ''}"
          onchange="current.blocks[${i}].url=this.value;markDirty();renderPreview();">
      </div>
    `;
  }
  if (b.type==="product"){
    return `
      <div class="field-group">
        <div class="field-label">Product title</div>
        <input type="text" value="${b.title || ''}"
          onchange="current.blocks[${i}].title=this.value;markDirty();renderPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">Description</div>
        <textarea rows="3"
          onchange="current.blocks[${i}].text=this.value;markDirty();renderPreview();">${b.text || ''}</textarea>
      </div>
      <div class="field-group">
        <div class="field-label">Image URL</div>
        <input type="url" value="${b.image || ''}"
          onchange="current.blocks[${i}].image=this.value;markDirty();renderPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">Amazon affiliate URL</div>
        <input type="url" value="${b.url || ''}"
          onchange="current.blocks[${i}].url=this.value;markDirty();renderPreview();">
      </div>
    `;
  }
  if (b.type==="podcast"){
    return `
      <div class="field-group">
        <div class="field-label">Episode title</div>
        <input type="text" value="${b.title || ''}"
          onchange="current.blocks[${i}].title=this.value;markDirty();renderPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">Podbean embed URL or iframe src</div>
        <textarea rows="3"
          onchange="current.blocks[${i}].embed=this.value;markDirty();renderPreview();">${b.embed || ''}</textarea>
      </div>
    `;
  }
  if (b.type==="youtube"){
    return `
      <div class="field-group">
        <div class="field-label">Video title</div>
        <input type="text" value="${b.title || ''}"
          onchange="current.blocks[${i}].title=this.value;markDirty();renderPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">YouTube URL or ID</div>
        <input type="text" value="${b.videoId || ''}"
          onchange="current.blocks[${i}].videoId=this.value;markDirty();renderPreview();">
      </div>
    `;
  }
  return "";
}

function addBlock(type){
  if (!current.blocks) current.blocks = [];
  const b = {type, motion:"fade"};
  if(type==="heading")   b.content="New heading";
  if(type==="paragraph") b.content="Your text here...";
  if(type==="image"){    b.mode="url"; b.content=""; }
  if(type==="button"){   b.text="Learn more"; b.url="#"; }
  if(type==="product"){  b.title="Product title"; b.text="Short description"; b.image=""; b.url=""; }
  if(type==="podcast"){  b.title="Episode title"; b.embed=""; }
  if(type==="youtube"){  b.title="Video title";   b.videoId=""; }
  current.blocks.push(b);
  markDirty();
  renderInspectorTab();
  renderPreview();
}

function moveBlock(i,d){
  const arr = current.blocks;
  const item = arr.splice(i,1)[0];
  let newIndex = i + d;
  if (newIndex < 0) newIndex = 0;
  if (newIndex > arr.length) newIndex = arr.length;
  arr.splice(newIndex,0,item);
  markDirty();
  renderInspectorTab();
  renderPreview();
}
function removeBlock(i){
  current.blocks.splice(i,1);
  markDirty();
  renderInspectorTab();
  renderPreview();
}

function handleImageUpload(e,index){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    current.blocks[index].content = reader.result;
    markDirty();
    renderPreview();
  };
  reader.readAsDataURL(file);
}

/* =======================
   MENU TAB HTML
======================= */
function renderMenuTabHtml(){
  ensureMenuArray();
  const menu = site.menu;
  let html = `
    <div class="panelSection">
      <div class="panelLabel">Main navigation</div>
      <p class="field-hint">
        Desktop header + mobile menu. Use <strong>Mega</strong> type for wide dropdown.
      </p>
      <button class="btn secondary" type="button" onclick="addMenuItem()">+ Add menu item</button>
    </div>
    <div class="panelSection">
  `;

  if (!menu.length){
    html += `<p class="field-hint">No menu items yet. Click “Add menu item” to get started.</p>`;
  }

  menu.forEach((item,i)=>{
    const type   = item.type   || "link";
    const showOn = item.showOn || "both";
    const label  = escapeHtml(item.label || item.title || "");
    const url    = escapeHtml(item.url || "");
    html += `
      <div class="block">
        <div class="block-header-line">
          <span class="block-type">ITEM ${i+1}</span>
          <span>
            Type:
            <select class="motion-select"
              onchange="changeMenuType(${i}, this.value)">
              <option value="link" ${type==='link'?'selected':''}>Link</option>
              <option value="mega" ${type==='mega'?'selected':''}>Mega</option>
            </select>
          </span>
        </div>

        <div class="field-group">
          <div class="field-label">Label</div>
          <input type="text" value="${label}"
            onchange="updateMenuField(${i}, 'label', this.value)">
        </div>

        <div class="field-group">
          <div class="field-label">URL</div>
          <input type="text" value="${url}"
            onchange="updateMenuField(${i}, 'url', this.value)">
          <div class="field-hint">
            Example: <code>index.html</code>, <code>podcast.html</code>, <code>#</code>, or full URL.
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Show on</div>
          <select onchange="updateMenuField(${i}, 'showOn', this.value)">
            <option value="both" ${showOn==='both'?'selected':''}>Desktop + mobile</option>
            <option value="desktop" ${showOn==='desktop'?'selected':''}>Desktop only</option>
            <option value="mobile" ${showOn==='mobile'?'selected':''}>Mobile only</option>
          </select>
        </div>

        <div class="tools">
          <button onclick="moveMenuItem(${i},-1)">↑</button>
          <button onclick="moveMenuItem(${i},1)">↓</button>
          <button onclick="removeMenuItem(${i})">×</button>
        </div>
    `;

    if (type === "mega"){
      const subs = Array.isArray(item.subItems) ? item.subItems : [];
      html += `
        <div class="section">
          <div class="panelLabel">Mega links</div>
          <p class="field-hint">
            Shown in the wide dropdown panel on desktop. Stacked on mobile.
          </p>
          <button class="btn secondary" type="button" onclick="addSubItem(${i})">+ Add mega link</button>
      `;
      subs.forEach((s,j)=>{
        const sLabel = escapeHtml(s.label || s.title || "");
        const sUrl   = escapeHtml(s.url || "");
        const sDesc  = escapeHtml(s.description || "");
        html += `
          <div class="block" style="margin-top:8px;">
            <div class="block-header-line">
              <span class="block-type">LINK ${j+1}</span>
              <button class="page-delete-btn" title="Remove link"
                onclick="removeSubItem(${i},${j});return false;">
                <i class="fa-regular fa-trash-can"></i>
              </button>
            </div>
            <div class="field-group">
              <div class="field-label">Label</div>
              <input type="text" value="${sLabel}"
                onchange="updateSubItemField(${i},${j},'label',this.value)">
            </div>
            <div class="field-group">
              <div class="field-label">URL</div>
              <input type="text" value="${sUrl}"
                onchange="updateSubItemField(${i},${j},'url',this.value)">
            </div>
            <div class="field-group">
              <div class="field-label">Description (optional)</div>
              <textarea rows="2"
                onchange="updateSubItemField(${i},${j},'description',this.value)">${sDesc}</textarea>
            </div>
          </div>
        `;
      });
      html += `</div>`;
    }

    html += `</div>`;
  });

  html += `</div>`;
  return html;
}

/* =======================
   UTIL
======================= */
function escapeHtml(str){
  return String(str || "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;");
}

/* =======================
   DRAFT SAVE
======================= */
function saveDraft(){
  try{
    localStorage.setItem(DRAFT_KEY, JSON.stringify(site));
    markSavedLocal(); // reuse pill style
  } catch(e){
    alert("Could not save draft locally.");
  }
}
function restoreDraftIfAny(){
  try{
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(parsed && typeof parsed === "object") {
      site = Object.assign({}, site, parsed);
    }
  } catch(e){
    console.warn("No valid draft to restore");
  }
}

/* =======================
   DOWNLOAD / BACKUP
======================= */
function downloadJson(){
  const blob = new Blob([JSON.stringify(site,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "site-data.json";
  a.click();
}

async function backupAll(){
  const zip = new JSZip();
  zip.file("site-data.json", JSON.stringify(site,null,2));

  const files = [
    "index.html",
    "podcast.html",
    "shop.html",
    "contact.html",
    "support.html",
    "admin.html",
    "dashboard.html",
    "assets/js/live.js"
  ];

  for(const f of files){
    try{
      const res = await fetch(f,{cache:"no-store"});
      if(res.ok){
        const text = await res.text();
        zip.file(f,text);
      }
    }catch(e){
      console.warn("Could not add to backup:", f);
    }
  }

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "honest-news-full-backup.zip";
  a.click();
}

/* =======================
   PUBLISH (Render → GitHub)
======================= */
document.getElementById("publishBtn").addEventListener("click", saveToCloud);

async function saveToCloud(){
  if(!confirm("Publish your changes to GitHub?")) return;

  try{
    const res = await fetch(SAVE_ENDPOINT,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(site)
    });

    const data = await res.json().catch(()=> ({}));

    if(!res.ok || !data.ok){
      throw new Error(data.error || ("HTTP " + res.status));
    }

    markSavedLocal();
    alert("✔ Published.\nRender → GitHub site-data.json updated.");

  }catch(e){
    console.error(e);
    alert("❌ Publish failed.\n" + e.message);
  }
}

/* mirror backup buttons */
document.getElementById("saveDraftBtn2").addEventListener("click", saveDraft);
document.getElementById("downloadBtn2").addEventListener("click", downloadJson);
document.getElementById("backupBtn2").addEventListener("click", backupAll);

/* =======================
   SITE TAB (PANEL BEHAVIOR)
======================= */
function renderSiteTabHtml(){
  return `
    <div class="panelSection">
      <div class="panelLabel">Panel behavior</div>
      <label class="inline" style="margin-bottom:4px;display:flex;">
        <input type="radio" name="panelBehavior" value="auto" ${panelBehavior==='auto'?'checked':''}>
        <span>Auto-open when editing</span>
      </label><br>
      <label class="inline" style="margin-bottom:4px;display:flex;">
        <input type="radio" name="panelBehavior" value="manual" ${panelBehavior==='manual'?'checked':''}>
        <span>Manual (use handle / Shift+P)</span>
      </label><br>
      <label class="inline" style="margin-bottom:4px;display:flex;">
        <input type="radio" name="panelBehavior" value="pinned" ${panelBehavior==='pinned'?'checked':''}>
        <span>Pinned open</span>
      </label><br>
      <label class="inline" style="margin-bottom:4px;display:flex;">
        <input type="radio" name="panelBehavior" value="smart" ${panelBehavior==='smart'?'checked':''}>
        <span>Smart (auto like Webflow)</span>
      </label>
      <p class="field-hint" style="margin-top:6px;">
        Your choice is saved per browser. “Smart” behaves like auto-open for now,
        but we can later hook it to more advanced logic.
      </p>
    </div>
    <div class="panelSection">
      <div class="panelLabel">Data & safety</div>
      <p class="field-hint">
        • “Publish” sends <code>site-data.json</code> to your Honest-News repo via Render (GitHub API).<br>
        • Drafts stay only in this browser’s local storage.<br>
        • Use GitHub Desktop to Commit & Push when you’re ready to go fully live.
      </p>
    </div>
  `;
}

function wirePanelBehaviorRadios(){
  document.querySelectorAll('input[name="panelBehavior"]').forEach(r=>{
    r.addEventListener("change", ()=>{
      panelBehavior = r.value;
      localStorage.setItem("hn_panel_behavior", panelBehavior);
      applyPanelBehavior();
    });
  });
}

/* initial inspector content */
renderInspectorTab();
</script>
</body>
</html>









