<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Honest News – Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PROTECT DASHBOARD: only enter if logged in -->
<script>
  if (localStorage.getItem("hn_logged") !== "yes") {
    // Only sends people to admin.html if not logged in.
    location.href = "admin.html";
  }
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  :root{
    --bg: #f3f4f6;
    --card-bg: #ffffff;
    --border: #e5e7eb;
    --shadow-soft: 0 18px 40px rgba(15,23,42,0.08);
    --accent: #2563eb;
    --accent-soft: #dbeafe;
    --text-main: #0f172a;
    --text-soft: #6b7280;
    --radius-lg: 18px;
    --radius-md: 12px;
    --radius-pill: 999px;
  }

  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background: radial-gradient(circle at top, #e5f0ff 0, #f3f4f6 40%, #e5e7eb 100%);
    color:var(--text-main);
    height:100vh;
    display:flex;
    flex-direction:column;
  }

  /* TOP BAR (WELCOME + SAVE TO GITHUB + LOGOUT) */
  .top-bar{
    background:#0066cc;
    color:white;
    padding:12px 40px;
    font-size:1.05rem;
    font-weight:600;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }
  .top-bar-buttons{
    position:absolute;
    right:20px;
    display:flex;
    gap:10px;
  }
  .top-bar-buttons button{
    background:#16a34a;
    color:white;
    border:none;
    padding:8px 18px;
    border-radius:10px;
    cursor:pointer;
    font-size:.85rem;
    font-weight:600;
  }
  .top-bar-buttons button.logout{
    background:#c33;
  }
  .top-bar-buttons button:hover{
    opacity:0.9;
  }

  /* HEADER */
  .header{
    padding:14px 24px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    backdrop-filter: blur(18px);
    background:rgba(255,255,255,0.86);
    border-bottom:1px solid rgba(148,163,184,0.18);
  }
  .header-left h1{
    margin:0;
    font-size:1.1rem;
    letter-spacing:.04em;
    text-transform:uppercase;
    color:#111827;
  }
  .header-left small{
    display:block;
    margin-top:2px;
    color:var(--text-soft);
    font-size:.75rem;
  }
  .header-right{
    display:flex;
    align-items:center;
    gap:10px;
    font-size:.8rem;
  }
  .pill{
    padding:4px 11px;
    border-radius:var(--radius-pill);
    background:#0f172a;
    color:#e5e7eb;
  }
  .pill.dirty{background:#b91c1c;color:#fee2e2;}
  .pill.saved{background:#166534;color:#dcfce7;}

  .btn{
    border:none;
    border-radius:var(--radius-pill);
    cursor:pointer;
    padding:7px 15px;
    font-size:.8rem;
    font-weight:600;
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:#0f172a;
    color:#e5e7eb;
  }
  .btn.secondary{background:#e5e7eb;color:#111827;}
  .btn.secondary:hover{background:#d1d5db;}
  .btn.ghost{background:transparent;color:#6b7280;}
  .btn.ghost:hover{color:#111827;}
  .btn.primary{background:#16a34a;color:#ecfdf5;}
  .btn.primary:hover{background:#15803d;}

  .main{
    flex:1;
    display:flex;
    padding:18px;
    gap:18px;
    min-height:0;
  }

  /* SIDEBAR */
  .sidebar{
    width:270px;
    background:rgba(255,255,255,0.96);
    border-radius:var(--radius-lg);
    padding:18px 16px;
    border:1px solid rgba(209,213,219,0.8);
    box-shadow:0 18px 40px rgba(15,23,42,0.06);
    display:flex;
    flex-direction:column;
    gap:14px;
    overflow:hidden;
  }
  .sidebar h3{
    margin:0;
    font-size:.78rem;
    text-transform:uppercase;
    letter-spacing:.1em;
    color:var(--text-soft);
  }
  .sidebar-inner{
    flex:1;
    overflow-y:auto;
    padding-right:4px;
  }
  .page{
    padding:9px 10px;
    margin-top:6px;
    border-radius:12px;
    background:#f9fafb;
    border:1px solid transparent;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-size:.84rem;
  }
  .page span.title{font-weight:600;}
  .page span.slug{font-size:.7rem;color:#9ca3af;}
  .page.active{
    background:var(--accent);
    color:#eff6ff;
    border-color:#1d4ed8;
  }

  .textarea-small{
    width:100%;
    border-radius:12px;
    border:1px solid var(--border);
    padding:8px;
    font-size:.78rem;
    font-family:inherit;
    resize:vertical;
    min-height:70px;
  }

  /* MENU DESIGNER */
  .menu-list{
    margin-top:6px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .menu-item-row{
    background:#f9fafb;
    border-radius:12px;
    border:1px solid #e5e7eb;
    padding:8px;
    font-size:.78rem;
  }
  .menu-item-row-top{
    display:flex;
    gap:6px;
    align-items:center;
    margin-bottom:4px;
  }
  .menu-item-row-top input[type="text"],
  .menu-item-row-top input[type="url"],
  .menu-item-row-top select{
    flex:1;
    padding:6px 8px;
    border-radius:8px;
    border:1px solid #cbd5e1;
    font-size:.78rem;
  }
  .menu-item-row-top .menu-actions{
    display:flex;
    gap:4px;
  }
  .menu-actions button{
    border:none;
    background:#e5e7eb;
    border-radius:999px;
    padding:4px 7px;
    cursor:pointer;
    font-size:.7rem;
  }
  .menu-actions button:hover{
    background:#d1d5db;
  }
  .menu-item-row-bottom{
    display:flex;
    flex-direction:column;
    gap:4px;
    margin-top:4px;
  }
  .menu-item-row-bottom textarea{
    width:100%;
    min-height:50px;
    border-radius:8px;
    border:1px solid #cbd5e1;
    padding:6px 8px;
    font-size:.76rem;
    resize:vertical;
  }
  .menu-flags{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    font-size:.74rem;
  }
  .menu-flags label{
    display:inline-flex;
    align-items:center;
    gap:4px;
  }

  /* CONTENT AREA */
  .content{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:14px;
    min-width:0;
  }

  .card{
    background:rgba(255,255,255,0.98);
    border-radius:var(--radius-lg);
    padding:18px 20px;
    border:1px solid rgba(209,213,219,0.8);
    box-shadow:var(--shadow-soft);
  }
  .card h2{
    margin:0 0 8px;
    font-size:1rem;
  }
  .card-sub{
    margin:0;
    font-size:.8rem;
    color:var(--text-soft);
  }

  /* TABS (Page / Hero / Blocks / Preview) */
  .tabs{
    display:flex;
    gap:6px;
    margin-bottom:10px;
    border-bottom:1px solid #e5e7eb;
    padding-bottom:4px;
  }
  .tab{
    padding:6px 10px;
    border-radius:999px;
    font-size:.78rem;
    cursor:pointer;
    color:#6b7280;
  }
  .tab.active{
    background:var(--accent-soft);
    color:#1d4ed8;
    font-weight:600;
  }

  /* FORM CONTROLS */
  .field-group{margin:6px 0;}
  .field-label{
    font-size:.78rem;
    font-weight:600;
    color:#4b5563;
    margin-bottom:2px;
  }
  .field-hint{
    font-size:.72rem;
    color:#9ca3af;
  }

  input,select,textarea{
    font-family:inherit;
  }

  input[type="text"],
  input[type="url"],
  textarea,
  select{
    width:100%;
    padding:9px 10px;
    border-radius:var(--radius-md);
    border:1px solid #cbd5e1;
    font-size:.82rem;
  }
  textarea{resize:vertical;min-height:70px;}

  label.inline{
    display:inline-flex;
    align-items:center;
    gap:4px;
    margin-right:10px;
    font-size:.78rem;
    color:#4b5563;
  }

  /* ACCORDION */
  .section{
    border-top:1px solid #e5e7eb;
    margin-top:10px;
    padding-top:10px;
  }
  .section-header{
    width:100%;
    background:none;
    border:none;
    padding:6px 0;
    display:flex;
    align-items:center;
    justify-content:space-between;
    cursor:pointer;
    font-size:.86rem;
    color:#111827;
  }
  .section-header .left{display:flex;align-items:center;gap:6px;}
  .section-header .arrow{
    font-size:.75rem;
    color:#9ca3af;
    transition:transform .25s ease,color .25s ease;
  }
  .section-header.open .arrow{
    transform:rotate(90deg);
    color:#4b5563;
  }
  .section-title{font-weight:600;}
  .section-body{
    max-height:0;
    opacity:0;
    overflow:hidden;
    transform:translateY(-4px);
    transition:max-height .3s ease,opacity .2s ease,transform .3s ease;
  }
  .section-body.open{
    max-height:1400px;
    opacity:1;
    transform:translateY(0);
  }
  .section-body-inner{padding:4px 0 8px;}

  /* BLOCKS */
  .block{
    margin:10px 0;
    padding:10px;
    background:#f9fafb;
    border-radius:var(--radius-md);
    border:1px dashed #cbd5e1;
    position:relative;
  }
  .block:hover{border-color:#22c55e;}
  .block-header-line{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:4px;
    font-size:.75rem;
    color:#6b7280;
  }
  .block-type{
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:.06em;
    font-size:.7rem;
  }
  .tools{
    position:absolute;
    right:6px;
    top:6px;
    display:flex;
    gap:4px;
    opacity:0;
    transition:opacity .2s;
  }
  .block:hover .tools{opacity:1;}
  .tools button{
    border:none;
    background:rgba(15,23,42,0.06);
    border-radius:999px;
    padding:2px 6px;
    font-size:.75rem;
    cursor:pointer;
  }

  .motion-select{
    width:auto;
    font-size:.72rem;
    padding:3px 6px;
    border-radius:999px;
  }

  /* PREVIEW */
  .preview-wrap{
    border-radius:var(--radius-md);
    border:1px solid #e5e7eb;
    overflow:hidden;
    background:#f9fafb;
  }
  #heroPreview{
    position:relative;
    background-size:cover;
    background-position:center;
    height:60vh;
  }
  #heroPreviewOverlay{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,0.65);
  }
  #heroPreviewInner{
    position:relative;
    color:#fff;
    text-align:center;
    padding-top:120px;
    padding-left:16px;
    padding-right:16px;
  }
  #heroPreviewInner h1{
    margin:0;
    font-size:2.1rem;
  }
  #heroPreviewInner p{
    margin-top:.6rem;
    font-size:.98rem;
    opacity:.9;
  }
  #blockPreview{
    padding:16px;
    background:#ffffff;
  }

  @media (max-width:900px){
    .main{flex-direction:column;}
    .sidebar{width:100%;}
  }
</style>
</head>
<body>

<!-- TOP BLUE BAR -->
<div class="top-bar">
  <span>Welcome back, Joseph</span>
  <div class="top-bar-buttons">
    <button onclick="saveToGithub()">SAVE TO GITHUB</button>
    <button class="logout" onclick="localStorage.removeItem('hn_logged');location.href='admin.html'">
      Log Out
    </button>
  </div>
</div>

<div class="header">
  <div class="header-left">
    <h1>Honest News Editor</h1>
    <small>Apple-smooth visual editor for your site</small>
  </div>
  <div class="header-right">
    <span id="saveStatus" class="pill">Clean</span>
    <button id="saveDraftBtn" class="btn secondary">
      <i class="fa-regular fa-floppy-disk"></i> Save
    </button>
    <button id="downloadBtn" class="btn ghost">
      Download JSON
    </button>
    <button id="backupBtn" class="btn ghost">
      Full backup (.zip)
    </button>
    <a href="index.html" target="_blank" class="btn ghost">
      View site ↗
    </a>
  </div>
</div>

<div class="main">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div>
      <h3>Pages</h3>
      <div class="sidebar-inner" id="pages"></div>
      <button class="btn secondary" style="width:100%;margin-top:8px;" onclick="newPage()">
        + New Page
      </button>
    </div>

    <div style="margin-top:16px;">
      <h3>Navigation</h3>
      <p class="field-hint" style="margin-top:4px;">
        Desktop + mobile menu. Each item can be <strong>simple</strong> or a future <strong>mega panel</strong>.
      </p>
      <div id="menuDesigner"></div>
    </div>
  </aside>

  <!-- CONTENT -->
  <section class="content">
    <div class="card" id="editorIntro">
      <h2>Choose a page to start editing</h2>
      <p class="card-sub">
        Pick a page on the left. You’ll edit its hero, content blocks, and overall feel here.
      </p>
    </div>

    <div class="card" id="editor" style="display:none;">
      <div class="tabs">
        <div class="tab active" data-tab="page" onclick="switchTab('page')">Page</div>
        <div class="tab" data-tab="hero" onclick="switchTab('hero')">Hero</div>
        <div class="tab" data-tab="blocks" onclick="switchTab('blocks')">Blocks</div>
        <div class="tab" data-tab="preview" onclick="switchTab('preview')">Preview</div>
      </div>

      <div id="tab-page" class="tab-panel"></div>
      <div id="tab-hero" class="tab-panel" style="display:none;"></div>
      <div id="tab-blocks" class="tab-panel" style="display:none;"></div>
      <div id="tab-preview" class="tab-panel" style="display:none;"></div>
    </div>
  </section>
</div>

<script>
/* =======================
   DATA MODEL
======================= */

let site = {
  menu: [
    { title:"Home",    url:"index.html",  type:"simple" },
    { title:"Podcast", url:"podcast.html",type:"simple" },
    { title:"Shop",    url:"shop.html",   type:"simple" },
    { title:"Support", url:"support.html",type:"simple" },
    { title:"Contact", url:"contact.html",type:"simple" }
  ],
  pages: [
    {
      title:"Home",
      slug:"home",
      theme:"dark",
      hero:{
        bg:"https://images.unsplash.com/photo-1506905925346-21bda4d32df4?auto=format&fit=crop&w=1920&q=80",
        overlay:"Honest News Network",
        sub:"Everything You Need for Biblical Truth",
        transparentMenu:false,
        behavior:"parallax-medium",
        size:"full",
        customHeight:""
      },
      blocks:[]
    },
    {
      title:"Podcast",
      slug:"podcast",
      theme:"dark",
      hero:{
        bg:"",
        overlay:"Latest Episodes",
        sub:"New episodes every Sunday",
        transparentMenu:true,
        behavior:"parallax-slow",
        size:"full",
        customHeight:""
      },
      blocks:[]
    },
    {
      title:"Shop",
      slug:"shop",
      theme:"dark",
      hero:{
        bg:"",
        overlay:"Recommended Resources",
        sub:"Support your walk and support the ministry",
        transparentMenu:true,
        behavior:"still",
        size:"medium",
        customHeight:""
      },
      blocks:[]
    }
  ]
};

let current = null;
let isDirty = false;
const DRAFT_KEY = "hn_cms_draft_v1";

/* =======================
   SAVE STATUS
======================= */
function markDirty(){
  isDirty = true;
  const pill = document.getElementById("saveStatus");
  pill.textContent = "Unsaved changes";
  pill.classList.add("dirty");
  pill.classList.remove("saved");
}
function markSavedLocal(){
  isDirty = false;
  const pill = document.getElementById("saveStatus");
  pill.textContent = "Saved";
  pill.classList.remove("dirty");
  pill.classList.add("saved");
}

/* =======================
   SIDEBAR / PAGES
======================= */
function renderPages(){
  const container = document.getElementById("pages");
  container.innerHTML = site.pages.map((p,i)=>`
    <div class="page ${p===current?'active':''}" onclick="selectPage(${i})">
      <span class="title">${p.title||'Untitled'}</span>
      <span class="slug">${p.slug||''}</span>
    </div>
  `).join("");
  renderMenuEditor();
}

function newPage(){
  const t = prompt("Page title?");
  if(!t) return;
  const slug = t.toLowerCase().replace(/\s+/g,"-");
  site.pages.push({
    title:t,
    slug,
    theme:"dark",
    hero:{bg:"",overlay:t,sub:"",transparentMenu:false,behavior:"still",size:"full",customHeight:""},
    blocks:[]
  });
  markDirty();
  renderPages();
}

/* =======================
   MENU DESIGNER
   - Simple now, future-ready for mega menus & mobile rules
======================= */
function renderMenuEditor(){
  const el = document.getElementById("menuDesigner");
  if(!el) return;
  if(!Array.isArray(site.menu)) site.menu = [];

  if(site.menu.length === 0){
    site.menu = [
      { title:"Home",    url:"index.html",  type:"simple" },
      { title:"Podcast", url:"podcast.html",type:"simple" }
    ];
  }

  el.innerHTML = `
    <div class="menu-list">
      ${site.menu.map((item,i)=>menuItemRow(item,i)).join("")}
    </div>
    <button class="btn secondary" style="width:100%;margin-top:8px;" type="button" onclick="addMenuItem()">
      + Add menu item
    </button>
  `;
}

function menuItemRow(item,i){
  const title = item.title || "";
  const url   = item.url   || "";
  const type  = item.type  || "simple";
  const summary = item.summary || "";
  const showDesktop = item.showDesktop !== false; // default true
  const showMobile  = item.showMobile  !== false; // default true

  return `
    <div class="menu-item-row">
      <div class="menu-item-row-top">
        <input type="text" placeholder="Title" value="${escapeHtml(title)}"
               onchange="updateMenuTitle(${i}, this.value)">
        <input type="url"  placeholder="URL" value="${escapeHtml(url)}"
               onchange="updateMenuUrl(${i}, this.value)">
        <select onchange="updateMenuType(${i}, this.value)">
          <option value="simple" ${type==='simple'?'selected':''}>Simple</option>
          <option value="mega"   ${type==='mega'?'selected':''}>Mega (panel)</option>
        </select>
        <div class="menu-actions">
          <button type="button" title="Move up" onclick="moveMenuItem(${i},-1)">↑</button>
          <button type="button" title="Move down" onclick="moveMenuItem(${i},1)">↓</button>
          <button type="button" title="Remove" onclick="removeMenuItem(${i})">×</button>
        </div>
      </div>
      <div class="menu-item-row-bottom">
        <textarea placeholder="Optional summary for dropdown / mega panel"
                  onchange="updateMenuSummary(${i}, this.value)">${escapeHtml(summary)}</textarea>
        <div class="menu-flags">
          <label>
            <input type="checkbox" ${showDesktop?'checked':''}
                   onchange="updateMenuShowDesktop(${i}, this.checked)">
            Show on Desktop
          </label>
          <label>
            <input type="checkbox" ${showMobile?'checked':''}
                   onchange="updateMenuShowMobile(${i}, this.checked)">
            Show on Mobile
          </label>
        </div>
      </div>
    </div>
  `;
}

function addMenuItem(){
  site.menu.push({
    title:"New item",
    url:"#",
    type:"simple",
    summary:"",
    showDesktop:true,
    showMobile:true
  });
  markDirty();
  renderMenuEditor();
}

function updateMenuTitle(i,val){
  site.menu[i].title = val;
  markDirty();
}
function updateMenuUrl(i,val){
  site.menu[i].url = val;
  markDirty();
}
function updateMenuType(i,val){
  site.menu[i].type = val;
  markDirty();
}
function updateMenuSummary(i,val){
  site.menu[i].summary = val;
  markDirty();
}
function updateMenuShowDesktop(i,checked){
  site.menu[i].showDesktop = checked;
  markDirty();
}
function updateMenuShowMobile(i,checked){
  site.menu[i].showMobile = checked;
  markDirty();
}
function moveMenuItem(i,d){
  const arr = site.menu;
  const item = arr.splice(i,1)[0];
  let newIndex = i + d;
  if(newIndex < 0) newIndex = 0;
  if(newIndex > arr.length) newIndex = arr.length;
  arr.splice(newIndex,0,item);
  markDirty();
  renderMenuEditor();
}
function removeMenuItem(i){
  if(!confirm("Remove this menu item?")) return;
  site.menu.splice(i,1);
  markDirty();
  renderMenuEditor();
}

/* =======================
   TABS
======================= */
function switchTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab===name);
  });
  document.querySelectorAll(".tab-panel").forEach(p=>{
    p.style.display = (p.id === "tab-"+name) ? "block" : "none";
  });
}

/* =======================
   EDITOR RENDER
======================= */
function selectPage(i){
  current = site.pages[i];
  renderPages();

  document.getElementById("editorIntro").style.display = "none";
  document.getElementById("editor").style.display = "block";

  renderTabPage();
  renderTabHero();
  renderTabBlocks();
  renderTabPreview();
  switchTab("page");
}

/* --- Page tab --- */
function renderTabPage(){
  const c = current;
  const el = document.getElementById("tab-page");
  const themeLight = c.theme==="light";

  el.innerHTML = `
    <h2 style="margin-top:0;">Page Settings</h2>
    <p class="card-sub">Basic details for this page.</p>

    <div class="section" style="border-top:none;margin-top:4px;">
      <div class="section-body open">
        <div class="section-body-inner">
          <div class="field-group">
            <div class="field-label">Title</div>
            <input type="text" value="${c.title||''}"
              onchange="current.title=this.value;markDirty();renderPages();">
          </div>

          <div class="field-group">
            <div class="field-label">Slug</div>
            <input type="text" value="${c.slug||''}"
              placeholder="home, podcast, shop..."
              onchange="current.slug=this.value;markDirty();renderPages();">
            <div class="field-hint">
              Used by <code>data-page="slug"</code> in your HTML &lt;body&gt;.
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Theme</div>
            <label class="inline">
              <input type="radio" name="theme" value="light" ${themeLight?'checked':''}
                onchange="current.theme='light';markDirty();">
              Light
            </label>
            <label class="inline">
              <input type="radio" name="theme" value="dark" ${!themeLight?'checked':''}
                onchange="current.theme='dark';markDirty();">
              Dark
            </label>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* --- Hero tab --- */
function renderTabHero(){
  const c = current;
  const el = document.getElementById("tab-hero");
  const h = c.hero || {};
  const size = h.size || "full";
  const behavior = h.behavior || "still";

  el.innerHTML = `
    <h2 style="margin-top:0;">Hero Settings</h2>
    <p class="card-sub">Control the big top section of this page.</p>

    <div class="section" style="border-top:none;margin-top:4px;">
      <div class="section-body open">
        <div class="section-body-inner">
          <div class="field-group">
            <div class="field-label">Background image URL</div>
            <input type="url" value="${h.bg||''}" placeholder="https://..."
              onchange="current.hero.bg=this.value;markDirty();renderTabPreview();">
          </div>

          <div class="field-group">
            <div class="field-label">Main title</div>
            <input type="text" value="${h.overlay||''}" placeholder="Main hero title"
              onchange="current.hero.overlay=this.value;markDirty();renderTabPreview();">
          </div>

          <div class="field-group">
            <div class="field-label">Subtitle</div>
            <input type="text" value="${h.sub||''}" placeholder="Optional subtitle"
              onchange="current.hero.sub=this.value;markDirty();renderTabPreview();">
          </div>

          <div class="field-group">
            <label class="inline">
              <input type="checkbox" ${h.transparentMenu?"checked":""}
                onchange="current.hero.transparentMenu=this.checked;markDirty();">
              Transparent header on this page
            </label>
          </div>

          <div class="field-group">
            <div class="field-label">Hero behavior</div>
            <select onchange="current.hero.behavior=this.value;markDirty();">
              <option value="still" ${behavior==='still'?'selected':''}>Still image</option>
              <option value="parallax-slow" ${behavior==='parallax-slow'?'selected':''}>Parallax – slow</option>
              <option value="parallax-medium" ${behavior==='parallax-medium'?'selected':''}>Parallax – medium</option>
              <option value="float-up" ${behavior==='float-up'?'selected':''}>Float up</option>
            </select>
          </div>

          <div class="field-group">
            <div class="field-label">Hero height</div>
            <label class="inline">
              <input type="radio" name="hero-size" value="small" ${size==="small"?'checked':''}
                onchange="setHeroSize('small')">
              Small (≈40vh)
            </label><br>
            <label class="inline">
              <input type="radio" name="hero-size" value="medium" ${size==="medium"?'checked':''}
                onchange="setHeroSize('medium')">
              Medium (≈60vh)
            </label><br>
            <label class="inline">
              <input type="radio" name="hero-size" value="large" ${size==="large"?'checked':''}
                onchange="setHeroSize('large')">
              Large (≈80vh)
            </label><br>
            <label class="inline">
              <input type="radio" name="hero-size" value="full" ${size==="full"?'checked':''}
                onchange="setHeroSize('full')">
              Fullscreen (100vh)
            </label><br>
            <label class="inline">
              <input type="radio" name="hero-size" value="custom" ${size==="custom"?'checked':''}
                onchange="setHeroSize('custom')">
              Custom:
            </label>
            <input type="text" value="${h.customHeight||''}" placeholder="e.g. 520px or 80vh"
              onchange="setHeroCustom(this.value)">
            <div class="field-hint">Custom height lets you match Podbean-style heroes exactly.</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function setHeroSize(size){
  if(!current.hero) current.hero = {};
  current.hero.size = size;
  markDirty();
  renderTabPreview();
}
function setHeroCustom(val){
  if(!current.hero) current.hero = {};
  current.hero.size = "custom";
  current.hero.customHeight = val.trim();
  markDirty();
  renderTabPreview();
}

/* --- Blocks tab --- */
function renderTabBlocks(){
  const el = document.getElementById("tab-blocks");
  const blocks = current.blocks || [];

  el.innerHTML = `
    <h2 style="margin-top:0;">Blocks</h2>
    <p class="card-sub">Add content sections, just like WordPress blocks.</p>

    <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;">
      <button class="btn secondary" type="button" onclick="addBlock('heading')">+ Heading</button>
      <button class="btn secondary" type="button" onclick="addBlock('paragraph')">+ Paragraph</button>
      <button class="btn secondary" type="button" onclick="addBlock('image')">+ Image</button>
      <button class="btn secondary" type="button" onclick="addBlock('button')">+ Button</button>
      <button class="btn secondary" type="button" onclick="addBlock('product')">+ Amazon product</button>
      <button class="btn secondary" type="button" onclick="addBlock('podcast')">+ Podcast</button>
      <button class="btn secondary" type="button" onclick="addBlock('youtube')">+ YouTube</button>
    </div>

    <div id="blocks" style="margin-top:10px;"></div>
  `;

  const blocksEl = document.getElementById("blocks");
  blocksEl.innerHTML = blocks.map((b,i)=>{
    const motion = b.motion || "fade";
    return `
      <div class="block">
        <div class="block-header-line">
          <span class="block-type">${b.type.toUpperCase()}</span>
          <span>
            Motion:
            <select class="motion-select"
              onchange="current.blocks[${i}].motion=this.value;markDirty();renderTabPreview();">
              <option value="none" ${motion==='none'?'selected':''}>None</option>
              <option value="fade" ${motion==='fade'?'selected':''}>Fade</option>
              <option value="float" ${motion==='float'?'selected':''}>Float</option>
              <option value="slide" ${motion==='slide'?'selected':''}>Slide</option>
            </select>
          </span>
        </div>

        ${renderBlockFields(b,i)}
        <div class="tools">
          <button onclick="moveBlock(${i},-1)" title="Move up">↑</button>
          <button onclick="moveBlock(${i},1)" title="Move down">↓</button>
          <button onclick="removeBlock(${i})" title="Remove block">×</button>
        </div>
      </div>
    `;
  }).join("");
}

function renderBlockFields(b,i){
  if(b.type==="heading"){
    return `
      <div class="field-group">
        <div class="field-label">Text</div>
        <input type="text" value="${b.content||''}"
          onchange="current.blocks[${i}].content=this.value;markDirty();renderTabPreview();">
      </div>
    `;
  }
  if(b.type==="paragraph"){
    return `
      <div class="field-group">
        <div class="field-label">Text</div>
        <textarea rows="4"
          onchange="current.blocks[${i}].content=this.value;markDirty();renderTabPreview();">${b.content||''}</textarea>
      </div>
    `;
  }
  if(b.type==="image"){
    const mode = b.mode==="upload"?"upload":"url";
    return `
      <div class="field-group">
        <div class="field-label">Image source</div>
        <select onchange="current.blocks[${i}].mode=this.value;markDirty();renderTabBlocks();">
          <option value="url" ${mode==='url'?'selected':''}>URL</option>
          <option value="upload" ${mode==='upload'?'selected':''}>Upload</option>
        </select>
      </div>
      ${
        mode==="upload"
        ? `<input type="file" accept="image/*" onchange="handleImageUpload(event,${i})">`
        : `
          <div class="field-group">
            <div class="field-label">Image URL</div>
            <input type="url" value="${b.content||''}"
              onchange="current.blocks[${i}].content=this.value;markDirty();renderTabPreview();">
          </div>`
      }
    `;
  }
  if(b.type==="button"){
    return `
      <div class="field-group">
        <div class="field-label">Button text</div>
        <input type="text" value="${b.text||''}"
          onchange="current.blocks[${i}].text=this.value;markDirty();renderTabPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">Button URL</div>
        <input type="url" value="${b.url||''}"
          onchange="current.blocks[${i}].url=this.value;markDirty();renderTabPreview();">
      </div>
    `;
  }
  if(b.type==="product"){
    return `
      <div class="field-group">
        <div class="field-label">Product title</div>
        <input type="text" value="${b.title||''}"
          onchange="current.blocks[${i}].title=this.value;markDirty();renderTabPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">Description</div>
        <textarea rows="3"
          onchange="current.blocks[${i}].text=this.value;markDirty();renderTabPreview();">${b.text||''}</textarea>
      </div>
      <div class="field-group">
        <div class="field-label">Image URL</div>
        <input type="url" value="${b.image||''}"
          onchange="current.blocks[${i}].image=this.value;markDirty();renderTabPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">Amazon affiliate URL</div>
        <input type="url" value="${b.url||''}"
          onchange="current.blocks[${i}].url=this.value;markDirty();renderTabPreview();">
      </div>
    `;
  }
  if(b.type==="podcast"){
    return `
      <div class="field-group">
        <div class="field-label">Episode title</div>
        <input type="text" value="${b.title||''}"
          onchange="current.blocks[${i}].title=this.value;markDirty();renderTabPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">Podbean embed URL or iframe src</div>
        <textarea rows="3"
          onchange="current.blocks[${i}].embed=this.value;markDirty();renderTabPreview();">${b.embed||''}</textarea>
      </div>
    `;
  }
  if(b.type==="youtube"){
    return `
      <div class="field-group">
        <div class="field-label">Video title</div>
        <input type="text" value="${b.title||''}"
          onchange="current.blocks[${i}].title=this.value;markDirty();renderTabPreview();">
      </div>
      <div class="field-group">
        <div class="field-label">YouTube URL or ID</div>
        <input type="text" value="${b.videoId||''}"
          onchange="current.blocks[${i}].videoId=this.value;markDirty();renderTabPreview();">
      </div>
    `;
  }
  return "";
}

function addBlock(type){
  if(!current.blocks) current.blocks=[];
  const b = {type, motion:"fade"};
  if(type==="heading") b.content="New heading";
  if(type==="paragraph") b.content="Your text here...";
  if(type==="image"){b.mode="url"; b.content="";}
  if(type==="button"){b.text="Learn more"; b.url="#";}
  if(type==="product"){b.title="Product title"; b.text="Short description"; b.image=""; b.url="";}
  if(type==="podcast"){b.title="Episode title"; b.embed="";}
  if(type==="youtube"){b.title="Video title"; b.videoId="";}
  current.blocks.push(b);
  markDirty();
  renderTabBlocks();
  renderTabPreview();
}

function moveBlock(i,d){
  const arr = current.blocks;
  const item = arr.splice(i,1)[0];
  let newIndex = i + d;
  if(newIndex < 0) newIndex = 0;
  if(newIndex > arr.length) newIndex = arr.length;
  arr.splice(newIndex,0,item);
  markDirty();
  renderTabBlocks();
  renderTabPreview();
}
function removeBlock(i){
  current.blocks.splice(i,1);
  markDirty();
  renderTabBlocks();
  renderTabPreview();
}

function handleImageUpload(e,index){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    current.blocks[index].content = reader.result;
    markDirty();
    renderTabPreview();
  };
  reader.readAsDataURL(file);
}

/* --- Preview tab --- */
function renderTabPreview(){
  const el = document.getElementById("tab-preview");
  const h = current.hero || {};
  const size = h.size || "full";

  el.innerHTML = `
    <h2 style="margin-top:0;">Live Preview</h2>
    <p class="card-sub">Rough simulation of how this page will feel.</p>

    <div class="preview-wrap" style="margin-top:10px;">
      <div id="heroPreview">
        <div id="heroPreviewOverlay"></div>
        <div id="heroPreviewInner">
          <h1>${escapeHtml(h.overlay||"")}</h1>
          <p>${escapeHtml(h.sub||"")}</p>
        </div>
      </div>
      <div id="blockPreview"></div>
    </div>
  `;

  const heroDiv = document.getElementById("heroPreview");
  if(h.bg){
    heroDiv.style.backgroundImage = `url('${h.bg}')`;
  } else {
    heroDiv.style.backgroundImage = "none";
    heroDiv.style.backgroundColor = "#020617";
  }

  // height
  let height = "60vh";
  if(size==="small") height="40vh";
  else if(size==="medium") height="60vh";
  else if(size==="large") height="80vh";
  else if(size==="full") height="100vh";
  else if(size==="custom" && h.customHeight) height = h.customHeight;
  heroDiv.style.height = height;

  // blocks render
  const blocksEl = document.getElementById("blockPreview");
  const blocks = current.blocks || [];
  let html = "";
  blocks.forEach(b=>{
    if(b.type==="heading"){
      html += `<h2 style="margin-top:1rem;">${escapeHtml(b.content||"")}</h2>`;
    } else if(b.type==="paragraph"){
      const text = (b.content||"").replace(/\n/g,"<br>");
      html += `<p style="margin-top:.4rem;color:#4b5563;font-size:.9rem;">${text}</p>`;
    } else if(b.type==="image" && b.content){
      html += `<img src="${escapeHtml(b.content)}" style="max-width:100%;border-radius:12px;margin:1rem 0;">`;
    } else if(b.type==="button"){
      html += `<a href="${escapeHtml(b.url||'#')}"
        style="display:inline-block;margin:0.7rem 0;padding:0.6rem 1.6rem;border-radius:999px;background:#16a34a;color:#ecfdf5;text-decoration:none;font-weight:600;font-size:.88rem;">
        ${escapeHtml(b.text||"Learn more")}
      </a>`;
    } else if(b.type==="product"){
      html += `
        <div style="background:#020617;color:#e5e7eb;border-radius:14px;margin:0.8rem 0;padding:0.9rem;display:flex;gap:0.9rem;align-items:flex-start;">
          ${b.image?`<img src="${escapeHtml(b.image)}" style="width:110px;border-radius:10px;object-fit:cover;">`:""}
          <div>
            <h3 style="margin:0 0 .3rem;font-size:.96rem;">${escapeHtml(b.title||"")}</h3>
            <p style="margin:0 0 .5rem;font-size:.8rem;color:#cbd5e1;">${escapeHtml(b.text||"")}</p>
            ${b.url?`<a href="${escapeHtml(b.url)}" target="_blank" rel="noopener noreferrer"
                style="display:inline-block;margin-top:0.2rem;padding:0.45rem 1.4rem;border-radius:999px;background:#22c55e;color:#022c22;font-size:.8rem;font-weight:600;text-decoration:none;">
                Buy on Amazon
              </a>`:""}
          </div>
        </div>
      `;
    } else if(b.type==="podcast" && b.embed){
      html += `
        <div style="margin:1.2rem 0;">
          <h3 style="margin:0 0 .3rem;">${escapeHtml(b.title||"")}</h3>
          <iframe src="${escapeHtml(b.embed)}"
            style="width:100%;height:150px;border:none;border-radius:10px;background:#0f172a;" allow="autoplay"></iframe>
        </div>
      `;
    } else if(b.type==="youtube" && b.videoId){
      let id = b.videoId.trim();
      const m = id.match(/v=([^&]+)/);
      if(m) id = m[1];
      html += `
        <div style="margin:1.2rem 0;">
          <h3 style="margin:0 0 .3rem;">${escapeHtml(b.title||"")}</h3>
          <div style="position:relative;padding-bottom:56.25%;height:0;border-radius:12px;overflow:hidden;">
            <iframe src="https://www.youtube.com/embed/${escapeHtml(id)}"
              style="position:absolute;top:0;left:0;width:100%;height:100%;border:none;"
              allowfullscreen></iframe>
          </div>
        </div>
      `;
    }
  });
  blocksEl.innerHTML = html;
}

/* =======================
   UTIL
======================= */
function escapeHtml(str){
  return String(str||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

/* =======================
   DRAFT SAVE
======================= */
function saveDraft(){
  try{
    localStorage.setItem(DRAFT_KEY, JSON.stringify(site));
    markSavedLocal();
  }catch(e){
    alert("Could not save draft locally.");
  }
}
function restoreDraftIfAny(){
  try{
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(parsed && parsed.pages) site = parsed;
  }catch(e){
    console.warn("No valid draft to restore");
  }
}

/* =======================
   DOWNLOAD / BACKUP
======================= */
function downloadJson(){
  const blob = new Blob([JSON.stringify(site,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "site-data.json";
  a.click();
}

async function backupAll(){
  const zip = new JSZip();
  zip.file("site-data.json", JSON.stringify(site,null,2));

  const files = [
    "index.html",
    "podcast.html",
    "shop.html",
    "contact.html",
    "support.html",
    "admin.html",
    "dashboard.html",
    "assets/js/live.js"
  ];

  for(const f of files){
    try{
      const res = await fetch(f,{cache:"no-store"});
      if(res.ok){
        const text = await res.text();
        zip.file(f,text);
      }
    }catch(e){
      console.warn("Could not add to backup:", f);
    }
  }

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "honest-news-full-backup.zip";
  a.click();
}

/* =======================
   INIT
======================= */
restoreDraftIfAny();
renderPages();

document.getElementById("saveDraftBtn").addEventListener("click", saveDraft);
document.getElementById("downloadBtn").addEventListener("click", downloadJson);
document.getElementById("backupBtn").addEventListener("click", backupAll);

/* =======================
   SAVE TO GITHUB BUTTON
   (current behavior: download site-data.json;
    your git / Grok flow still pushes it)
======================= */
async function saveToGithub() {
  if (!confirm("Download updated site-data.json now?")) return;
  const data = JSON.stringify(site, null, 2);
  const blob = new Blob([data], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'site-data.json';
  a.click();
  alert("Downloaded! Commit / push this file in Git and the site will update.");
}
</script>
<script>
  async function saveToGitHub() {
    // Confirm before pushing changes
    if (!confirm("Push all changes to GitHub now?")) {
      return;
    }

    // Ensure the CMS config is loaded
    if (!window.CMS_CONFIG || !window.CMS_CONFIG.token) {
      alert("Error: Missing GitHub token in configuration.");
      return;
    }

    // Prepare the data to be pushed
    const data = JSON.stringify(siteData, null, 2);

    // GitHub API endpoint for the file
    const endpoint = `https://api.github.com/repos/${CMS_CONFIG.repoUser}/${CMS_CONFIG.repoName}/contents/${CMS_CONFIG.dataFile}`;

    // Fetch the current file's SHA to update it properly
    const existingFile = await fetch(endpoint, {
      headers: { Authorization: `token ${CMS_CONFIG.token}` }
    }).then(response => response.json());

    // If the file exists, get its SHA
    const sha = existingFile.sha;

    // Push the new content to GitHub
    const response = await fetch(endpoint, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `token ${CMS_CONFIG.token}`
      },
      body: JSON.stringify({
        message: "Update site-data.json from dashboard",
        content: btoa(unescape(encodeURIComponent(data))),
        sha: sha
      })
    });

    // Notify the user of the result
    if (response.ok) {
      alert("Saved! Site updates in about 5 seconds.");
    } else {
      alert("Error saving. Check your token or repository configuration.");
    }
  }
</script>
</body>
</html>


