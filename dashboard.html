<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Honest News – Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PROTECT DASHBOARD: only enter if logged in -->
<script>
  if (localStorage.getItem("hn_logged") !== "yes") {
    location.href = "admin.html";
  }
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  :root{
    --bg: #02040a;
    --card-bg: #05070c;
    --border: #1f2937;
    --shadow-soft: 0 20px 45px rgba(0,0,0,0.75);
    --accent: #0ea5e9;
    --accent-soft: #0369a1;
    --accent-soft-bg: rgba(14,165,233,.12);
    --text-main: #e5e7eb;
    --text-soft: #9ca3af;
    --radius-lg: 20px;
    --radius-md: 12px;
    --radius-pill: 999px;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    background:radial-gradient(circle at top, #1e293b 0, #020617 48%, #000 100%);
    color:var(--text-main);
    height:100vh;
    display:flex;
    flex-direction:column;
    -webkit-font-smoothing: antialiased;
    overflow:hidden;
  }
  .main{
    flex:1;
    display:flex;
    padding:16px;
    gap:16px;
    min-height:0;
  }
  /* Sidebar Lever Fix */
  .sidebar {
    position: relative;
    transition: margin-left .26s cubic-bezier(.55,0,.4,1);
    z-index: 10;
    width:260px;
    background:rgba(3,7,18,0.98);
    border-radius:var(--radius-lg);
    padding:16px 14px;
    border:1px solid rgba(148,163,184,0.35);
    box-shadow:0 18px 40px rgba(0,0,0,0.85);
    display:flex;
    flex-direction:column;
    gap:14px;
    overflow:hidden;
    min-height: 0;
  }
  .sidebar-collapsed {
    margin-left: -260px !important;
    transition: margin-left .26s cubic-bezier(.55,0,.4,1);
  }
  .sidebar-show-btn {
    display: none;
  }
  @media (max-width:900px){
    .main{flex-direction:column;}
    .sidebar{width:100%;max-width:100vw;}
    #panelHandle{top:auto;bottom:90px;}
  }
  /* Add here the rest of your .sidebar-section, .btn, .page, etc. styles from your original dashboard */
  /* (Keep all your detailed original CSS for components here, as before.) */
  /* ... [REMAINDER OF YOUR CSS GOES HERE, UNCHANGED] ... */
</style>
</head>
<body>
<div class="top-welcome">
  <div class="top-left">
    <span class="label">Honest News · Dashboard</span>
    <span class="title">Welcome back, Joseph</span>
  </div>
  <div class="top-actions">
    <span class="pill-badge">
      <i class="fa-regular fa-circle-dot"></i>
      Publish path: Render → GitHub
    </span>
    <button class="logout-btn"
            onclick="localStorage.removeItem('hn_logged');location.href='admin.html'">
      <i class="fa-solid fa-right-from-bracket"></i> Log Out
    </button>
  </div>
</div>
<div class="main">
  <!-- SIDEBAR with lever -->
  <aside class="sidebar" id="sidebarPanel">
    <!-- Hide Sidebar Lever Button -->
    <button id="hideSidebarBtn" style="position:absolute;top:16px;right:-18px;width:18px;height:42px;z-index:20;background:var(--accent);color:#fff;border-radius:0 12px 12px 0;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;">
      <i class="fa-solid fa-angle-left"></i>
    </button>
    <!-- Sidebar content: PAGES & NAVIGATION -->
    <div class="sidebar-section">
      <button class="sidebar-section-header" type="button" onclick="toggleSidebarSection('pages')">
        <span class="label">Pages</span>
        <i class="fa-solid fa-chevron-right sidebar-chevron" id="pagesChevron"></i>
      </button>
      <div class="sidebar-section-body closed" id="pagesSection">
        <div class="sidebar-inner" id="pages"></div>
        <button class="btn secondary" style="width:100%;margin-top:8px;" onclick="newPage()">
          + New Page
        </button>
      </div>
    </div>
    <div class="sidebar-section">
      <button class="sidebar-section-header" type="button" onclick="toggleSidebarSection('nav')">
        <span class="label">Navigation (raw)</span>
        <i class="fa-solid fa-chevron-right sidebar-chevron" id="navChevron"></i>
      </button>
      <div class="sidebar-section-body closed" id="navSection">
        <p class="field-hint" style="margin-top:4px;">
          One per line: <code>Title | URL</code><br>
          <strong>Tip:</strong> If you use the Menu tab + mega menu, avoid editing this.
        </p>
        <textarea id="menuRaw" class="textarea-small" oninput="menuFromRaw(this.value)"></textarea>
      </div>
    </div>
  </aside>
  <!-- Show Sidebar Button (lever appears when hidden) -->
  <button class="sidebar-show-btn" id="showSidebarBtn" style="display:none;position:fixed;top:88px;left:0;z-index:2000;background:var(--accent);color:#fff;width:18px;height:42px;border:none;border-radius:0 12px 12px 0;align-items:center;justify-content:center;cursor:pointer;">
    <i class="fa-solid fa-angle-right"></i>
  </button>
  <!-- PREVIEW ONLY -->
  <section class="content">
    <!-- [PREVIEW + INSPECTOR UI will go here in part 2] -->
    <div id="previewCard">
      <div id="previewToolbar">
        <div id="previewTitle">
          <span id="previewPageTitle">No page selected</span>
          <span class="slug" id="previewPageSlug"></span>
        </div>
        <div class="device-toggle-group">
          <button class="device-btn active" data-device="desktop"><i class="fa-solid fa-display"></i></button>
          <button class="device-btn" data-device="tablet"><i class="fa-solid fa-tablet-screen-button"></i></button>
          <button class="device-btn" data-device="mobile"><i class="fa-solid fa-mobile-screen"></i></button>
        </div>
      </div>
      <div id="previewInnerWrap">
        <div id="previewFrame" class="desktop">
          <div class="preview-wrap">
            <div id="heroPreview">
              <div id="heroPreviewOverlay"></div>
              <div id="heroPreviewInner">
                <h1>Pick a page on the left</h1>
                <p>Then use the sliding panel to edit Page, Hero, Blocks, and Menu.</p>
              </div>
            </div>
            <div id="blockPreview"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- RIGHT PANEL HANDLE + INSPECTOR -->
<div id="panelHandle" title="Open inspector">◂</div>
<div id="inspectorPanel">
  <div id="panelHeader">
    <div id="panelHeaderLeft">
      <span class="title">Inspector</span>
      <span class="sub" id="panelPageLabel">No page selected</span>
    </div>
    <div id="panelHeaderRight">
      <span id="saveStatusRight" class="pill">Clean</span>
      <button id="closePanelBtn">×</button>
    </div>
  </div>
  <div id="inspectorTabs">
    <button class="inspect-tab active" data-inspect="page">Page</button>
    <button class="inspect-tab" data-inspect="hero">Hero</button>
    <button class="inspect-tab" data-inspect="blocks">Blocks</button>
    <button class="inspect-tab" data-inspect="menu">Menu</button>
    <button class="inspect-tab" data-inspect="site">Site</button>
  </div>
  <div id="inspectorBody"></div>
  <div style="margin-top:10px;">
    <button id="publishBtn" class="btn primary" style="width:100%;margin-bottom:6px;">
      <i class="fa-solid fa-cloud-arrow-up"></i> Publish
    </button>
    <button id="saveDraftBtn2" class="btn secondary" style="width:100%;margin-bottom:4px;">
      Save Draft (this browser)
    </button>
    <button id="downloadBtn2" class="btn ghost" style="width:100%;margin-bottom:4px;">
      Download JSON
    </button>
    <button id="backupBtn2" class="btn ghost" style="width:100%;margin-bottom:4px;">
      Full backup (.zip)
    </button>
    <a href="index.html" target="_blank" class="btn ghost" style="width:100%;text-decoration:none;justify-content:center;">
      View site ↗
    </a>
  </div>
</div>

<!-- ===================== -->
<!-- PART 3: SCRIPT BEGINS -->
<!-- ===================== -->
<script>
/* === SIDEBAR LEVER LOGIC (MUST GO FIRST) === */
document.addEventListener("DOMContentLoaded", function() {
  const sidebar = document.getElementById('sidebarPanel');
  const hideSidebar = document.getElementById('hideSidebarBtn');
  const showSidebar = document.getElementById('showSidebarBtn');
  hideSidebar.addEventListener('click', () => {
    sidebar.classList.add('sidebar-collapsed');
    showSidebar.style.display = 'flex';
    setTimeout(()=>{ sidebar.style.zIndex = '1'; }, 240);
  });
  showSidebar.addEventListener('click', () => {
    sidebar.classList.remove('sidebar-collapsed');
    showSidebar.style.display = 'none';
    sidebar.style.zIndex = '10';
  });
  // Optional: On load, reset
  sidebar.classList.remove('sidebar-collapsed');
  showSidebar.style.display = 'none';
  // Mobile auto-hide
  window.addEventListener('resize', () => {
    if(window.innerWidth < 600){
      sidebar.classList.add('sidebar-collapsed');
      showSidebar.style.display = 'flex';
      sidebar.style.zIndex = '1';
    } else {
      sidebar.classList.remove('sidebar-collapsed');
      showSidebar.style.display = 'none';
      sidebar.style.zIndex = '10';
    }
  });
});

/* =======================
   STATE
======================= */
let site = { menu: [], pages: [], theme: {}, heroSlides: [] };
let current = null;
let isDirty = false;
let activeInspectorTab = "page";
const DRAFT_KEY = "hn_cms_draft_v1";
let panelBehavior = localStorage.getItem("hn_panel_behavior") || "auto";
const panel    = document.getElementById("inspectorPanel");
const handle   = document.getElementById("panelHandle");
const closeBtn = document.getElementById("closePanelBtn");
const saveStatusRight = document.getElementById("saveStatusRight");
const SAVE_ENDPOINT = "https://honest-news.onrender.com/save";

(async function loadSiteData() {
  let loadedFromServer = false;
  try {
    const res = await fetch("site-data.json?cache-bust=" + Date.now());
    if (res.ok) {
      const data = await res.json();
      if (data && typeof data === "object") {
        site = Object.assign({}, site, data);
        loadedFromServer = true;
      }
    }
  } catch (e) {
    console.warn("Could not load site-data.json, will try local draft instead", e);
  }
  if (!loadedFromServer) restoreDraftIfAny();
  renderPages();
  updatePreviewHeader();
  renderPreview();
  applyPanelBehavior();
  renderInspectorTab();
})();

function markDirty(){
  isDirty = true;
  if (saveStatusRight){
    saveStatusRight.textContent = "Unsaved changes";
    saveStatusRight.classList.add("dirty");
    saveStatusRight.classList.remove("saved");
  }
}
function markSavedLocal(){
  isDirty = false;
  if (saveStatusRight){
    saveStatusRight.textContent = "Published";
    saveStatusRight.classList.remove("dirty");
    saveStatusRight.classList.add("saved");
  }
}

/* ======================= */
/* END OF PART 2           */
/* ======================= */
/* =======================
   LEFT SIDEBAR ACCORDION
======================= */
function toggleSidebarSection(which){
  const body    = document.getElementById(which + "Section");
  const chevron = document.getElementById(which + "Chevron");
  if (!body) return;
  const wasClosed = body.classList.contains("closed");
  // Close all
  document.querySelectorAll(".sidebar-section-body").forEach(el=>{
    el.classList.add("closed");
  });
  document.querySelectorAll(".sidebar-chevron").forEach(el=>{
    el.classList.remove("rotated");
  });
  // If it was closed, open it
  if (wasClosed){
    body.classList.remove("closed");
    if (chevron) chevron.classList.add("rotated");
  }
}
function openSidebarSection(which){
  const body    = document.getElementById(which + "Section");
  const chevron = document.getElementById(which + "Chevron");
  if (!body) return;
  document.querySelectorAll(".sidebar-section-body").forEach(el=>{
    el.classList.add("closed");
  });
  document.querySelectorAll(".sidebar-chevron").forEach(el=>{
    el.classList.remove("rotated");
  });
  body.classList.remove("closed");
  if (chevron) chevron.classList.add("rotated");
}

/* =======================
   PANEL BEHAVIOR + OPEN/CLOSE
======================= */
function isPanelOpen(){ return panel.classList.contains("open"); }
function openPanel(reason){
  if (panelBehavior === "manual" && reason !== "manual") return;
  panel.classList.add("open");
  handle.style.display = "none";
}
function closePanel(reason){
  if (panelBehavior === "pinned") return;
  panel.classList.remove("open");
  handle.style.display = "flex";
}
function togglePanelManual(){
  if (isPanelOpen()) closePanel("manual");
  else openPanel("manual");
}
function applyPanelBehavior(){
  if (panelBehavior === "pinned") {
    panel.classList.add("open");
    handle.style.display = "none";
  } else {
    handle.style.display = isPanelOpen() ? "none" : "flex";
  }
}
handle.addEventListener("click", ()=>togglePanelManual());
closeBtn.addEventListener("click", ()=>closePanel("manual"));
document.addEventListener("keydown", (e)=>{
  if(e.shiftKey && e.key.toLowerCase()==="p"){
    togglePanelManual();
  }
});

/* =======================
   SIDEBAR / PAGES
======================= */
function renderPages(){
  const container = document.getElementById("pages");
  const pagesArr = site.pages || [];
  if (!container) return;
  container.innerHTML = pagesArr.map((p,i)=>`
    <div class="page ${p===current?'active':''}" onclick="selectPage(${i})">
      <div class="page-main">
        <span class="title">${p.title || 'Untitled'}</span>
        <span class="slug">${p.slug || ''}</span>
      </div>
      <button class="page-delete-btn" title="Delete page"
        onclick="event.stopPropagation();deletePage(${i});">
        <i class="fa-regular fa-trash-can"></i>
      </button>
    </div>
  `).join("");
  rawFromMenu();
}
function newPage(){
  const t = prompt("Page title?");
  if (!t) return;
  const slug = t.toLowerCase().replace(/\s+/g,"-");
  if (!site.pages) site.pages = [];
  site.pages.push({
    title:t,
    slug,
    theme:"dark",
    hero:{
      bg:"",
      overlay:t,
      sub:"",
      transparentMenu:false,
      behavior:"still",
      size:"full",
      customHeight:""
    },
    blocks:[]
  });
  markDirty();
  renderPages();
  openSidebarSection("pages");
}
function deletePage(index){
  const page = (site.pages || [])[index];
  if (!page) return;
  if (!confirm(`Delete page "${page.title || page.slug || 'Untitled'}"?\nThis will also remove it from the navigation menu.`)) {
    return;
  }
  const slug = page.slug || "";
  const url1 = slug ? slug + ".html" : "";
  const url2 = slug;
  if (Array.isArray(site.menu)){
    site.menu = site.menu.filter(item =>
      item.url !== url1 && item.url !== url2
    );
  }
  site.pages.splice(index,1);
  if (current === page){
    current = site.pages[0] || null;
  }
  markDirty();
  renderPages();
  updatePreviewHeader();
  renderPreview();
  rawFromMenu();
}

/* =======================
   MENU EDITOR (RAW)
======================= */
function rawFromMenu(){
  const ta = document.getElementById("menuRaw");
  if(!ta) return;
  const menuArr = site.menu || [];
  ta.value = menuArr.map(m=>`${m.label || m.title || 'Item'} | ${m.url || "#"}`).join("\n");
}
function menuFromRaw(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  site.menu = lines.map((l,idx)=>{
    const [title,url] = l.split("|").map(s=>(s||"").trim());
    return {
      id: (title || "item-"+idx).toLowerCase().replace(/\s+/g,"-"),
      label: title || "Item",
      url: url || "#",
      type:"link",
      showOn:"both",
      subItems:[]
    };
  });
  markDirty();
}

/* =======================
   SELECT PAGE
======================= */
function selectPage(i){
  current = site.pages[i];
  renderPages();
  updatePreviewHeader();
  renderPreview();
  renderInspectorTab();
  if (panelBehavior === "auto" || panelBehavior === "pinned" || panelBehavior === "smart"){
    openPanel("auto");
  }
}

/* =======================
   PREVIEW
======================= */
function updatePreviewHeader(){
  const tEl = document.getElementById("previewPageTitle");
  const sEl = document.getElementById("previewPageSlug");
  const pl  = document.getElementById("panelPageLabel");
  if (!current){
    if (tEl) tEl.textContent = "No page selected";
    if (sEl) sEl.textContent = "";
    if (pl)  pl.textContent  = "No page selected";
    return;
  }
  if (tEl) tEl.textContent = current.title || "Untitled";
  if (sEl) sEl.textContent = current.slug || "";
  if (pl)  pl.textContent  = current.title + (current.slug ? ` (${current.slug})` : "");
}
function renderPreview(){
  const h = current && current.hero ? current.hero : {
    overlay:"Pick a page",
    sub:"Use the left bar to choose a page"
  };
  const heroDiv = document.getElementById("heroPreview");
  const titleEl = document.getElementById("heroPreviewInner").querySelector("h1");
  const subEl   = document.getElementById("heroPreviewInner").querySelector("p");
  titleEl.textContent = h.overlay || "";
  subEl.textContent   = h.sub || "";
  if (h.bg){
    heroDiv.style.backgroundImage = `url('${h.bg}')`;
  } else {
    heroDiv.style.backgroundImage = "none";
    heroDiv.style.backgroundColor = "#020617";
  }
  let height = "60vh";
  const size = h.size || "full";
  if(size==="small")  height="40vh";
  else if(size==="medium") height="60vh";
  else if(size==="large")  height="80vh";
  else if(size==="full")   height="100vh";
  else if(size==="custom" && h.customHeight) height = h.customHeight;
  heroDiv.style.height = height;
  const blocksEl = document.getElementById("blockPreview");
  const blocks = (current && current.blocks) ? current.blocks : [];
  let html = "";
  blocks.forEach(b=>{
    if(b.type==="heading"){
      html += `<h2 style="margin-top:1rem;color:#e5e7eb;font-size:1.1rem;">${escapeHtml(b.content || "")}</h2>`;
    } else if(b.type==="paragraph"){
      const text = (b.content || "").replace(/\n/g,"<br>");
      html += `<p style="margin-top:.4rem;color:#9ca3af;font-size:.9rem;">${text}</p>`;
    } else if(b.type==="image" && b.content){
      html += `<img src="${escapeHtml(b.content)}" style="max-width:100%;border-radius:12px;margin:1rem 0;">`;
    } else if(b.type==="button"){
      html += `<a href="${escapeHtml(b.url || '#')}"
        style="display:inline-block;margin:0.7rem 0;padding:0.6rem 1.6rem;border-radius:999px;background:var(--accent);color:#0b1120;text-decoration:none;font-weight:600;font-size:.88rem;">
        ${escapeHtml(b.text || "Learn more")}
      </a>`;
    } else if(b.type==="product"){
      html += `
        <div style="background:#020617;border-radius:14px;margin:0.8rem 0;padding:0.9rem;display:flex;gap:0.9rem;align-items:flex-start;border:1px solid rgba(55,65,81,.8);">
          ${b.image ? `<img src="${escapeHtml(b.image)}" style="width:110px;border-radius:10px;object-fit:cover;">` : ""}
          <div>
            <h3 style="margin:0 0 .3rem;font-size:.96rem;color:#e5e7eb;">${escapeHtml(b.title || "")}</h3>
            <p style="margin:0 0 .5rem;font-size:.8rem;color:#9ca3af;">${escapeHtml(b.text || "")}</p>
            ${b.url ? `<a href="${escapeHtml(b.url)}" target="_blank" rel="noopener noreferrer"
                style="display:inline-block;margin-top:0.2rem;padding:0.45rem 1.4rem;border-radius:999px;background:var(--accent);color:#0b1120;font-size:.8rem;font-weight:600;text-decoration:none;">
                Buy on Amazon
              </a>` : ""}
          </div>
        </div>
      `;
    } else if(b.type==="podcast" && b.embed){
      html += `
        <div style="margin:1.2rem 0;">
          <h3 style="margin:0 0 .3rem;color:#e5e7eb;">${escapeHtml(b.title || "")}</h3>
          <iframe src="${escapeHtml(b.embed)}"
            style="width:100%;height:150px;border:none;border-radius:10px;background:#0f172a;" allow="autoplay"></iframe>
        </div>
      `;
    } else if(b.type==="youtube" && b.videoId){
      let id = b.videoId.trim();
      const m = id.match(/v=([^&]+)/);
      if(m) id = m[1];
      html += `
        <div style="margin:1.2rem 0;">
          <h3 style="margin:0 0 .3rem;color:#e5e7eb;">${escapeHtml(b.title || "")}</h3>
          <div style="position:relative;padding-bottom:56.25%;height:0;border-radius:12px;overflow:hidden;">
            <iframe src="https://www.youtube.com/embed/${escapeHtml(id)}"
              style="position:absolute;top:0;left:0;width:100%;height:100%;border:none;"
              allowfullscreen></iframe>
          </div>
        </div>
      `;
    }
  });
  blocksEl.innerHTML = html;
}
/* DEVICE PREVIEW */
const previewFrame = document.getElementById("previewFrame");
document.querySelectorAll(".device-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const mode = btn.dataset.device;
    previewFrame.classList.remove("desktop","tablet","mobile");
    previewFrame.classList.add(mode);
    document.querySelectorAll(".device-btn").forEach(b=>{
      b.classList.toggle("active", b===btn);
    });
  });
});

/* =======================
   INSPECTOR TABS
======================= */
document.querySelectorAll(".inspect-tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    activeInspectorTab = tab.dataset.inspect;
    document.querySelectorAll(".inspect-tab").forEach(t=>{
      t.classList.toggle("active", t===tab);
    });
    renderInspectorTab();
    if (panelBehavior === "auto" || panelBehavior === "pinned" || panelBehavior === "smart"){
      openPanel("auto");
    }
  });
});

/* =======================
   END OF PART 3
======================= */
/* =======================
   MENU EDITOR (GRAPHIC TAB)
======================= */
function ensureMenuArray(){
  if (!Array.isArray(site.menu)) {
    site.menu = [];
  }
}
function addMenuItem(){
  ensureMenuArray();
  const newItem = {
    id: "item-" + Date.now(),
    label: "New item",
    url: "#",
    type: "link",
    showOn: "both",
    subItems: []
  };
  site.menu.push(newItem);
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}
function removeMenuItem(index){
  ensureMenuArray();
  const item = site.menu[index];
  if (!item) return;
  if (!confirm(`Remove menu item "${item.label || item.title || 'Item'}"?`)) return;
  site.menu.splice(index,1);
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}
function moveMenuItem(i,d){
  ensureMenuArray();
  const arr = site.menu;
  const item = arr.splice(i,1)[0];
  let newIndex = i + d;
  if (newIndex < 0) newIndex = 0;
  if (newIndex > arr.length) newIndex = arr.length;
  arr.splice(newIndex,0,item);
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}
function changeMenuType(index,type){
  ensureMenuArray();
  const item = site.menu[index];
  if (!item) return;
  item.type = type;
  if (type === "mega" && !Array.isArray(item.subItems)) {
    item.subItems = [];
  }
  if (type !== "mega") {
    item.subItems = [];
  }
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}
function updateMenuField(index, field, value){
  ensureMenuArray();
  const item = site.menu[index];
  if (!item) return;
  if (field === "label") {
    item.label = value;
    // keep id loosely in sync on first edits (optional)
    if (!item.id || item.id.startsWith("item-")) {
      item.id = value.toLowerCase().replace(/\s+/g,"-") || ("item-"+index);
    }
  } else if (field === "url") {
    item.url = value;
  } else if (field === "showOn") {
    item.showOn = value;
  }
  markDirty();
  rawFromMenu();
}
function addSubItem(menuIndex){
  ensureMenuArray();
  const item = site.menu[menuIndex];
  if (!item) return;
  if (!Array.isArray(item.subItems)) item.subItems = [];
  item.subItems.push({
    label: "New link",
    url: "#",
    description: ""
  });
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}
function removeSubItem(menuIndex, subIndex){
  ensureMenuArray();
  const item = site.menu[menuIndex];
  if (!item || !Array.isArray(item.subItems)) return;
  item.subItems.splice(subIndex,1);
  markDirty();
  rawFromMenu();
  renderInspectorTab();
}
function updateSubItemField(menuIndex, subIndex, field, value){
  ensureMenuArray();
  const item = site.menu[menuIndex];
  if (!item || !Array.isArray(item.subItems)) return;
  const sub = item.subItems[subIndex];
  if (!sub) return;
  if (field === "label") sub.label = value;
  else if (field === "url") sub.url = value;
  else if (field === "description") sub.description = value;
  markDirty();
  rawFromMenu();
}

/* =======================
   SAVE/LOAD/DRAFT/BACKUP
======================= */
function restoreDraftIfAny(){
  const str = localStorage.getItem(DRAFT_KEY);
  if (str){
    try{
      const obj = JSON.parse(str);
      if(obj && typeof obj === "object" && obj.pages){
        site = obj;
      }
    }catch(e){}
  }
}
function saveDraft(){
  localStorage.setItem(DRAFT_KEY, JSON.stringify(site));
  markSavedLocal();
}
function downloadJSON(){
  const a = document.createElement('a');
  a.href = "data:application/json," + encodeURIComponent(JSON.stringify(site,null,2));
  a.download = "site-data.json";
  a.click();
}
function backupZip(){
  const zip = new JSZip();
  zip.file("site-data.json", JSON.stringify(site,null,2));
  zip.generateAsync({type:"blob"}).then(function(content) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = "honest-news-backup.zip";
    a.click();
  });
}
function publishToCloud(){
  saveDraft();
  fetch(SAVE_ENDPOINT, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(site)
  }).then(res=>{
    if(res.ok) markSavedLocal();
    else alert("Error publishing site.");
  }).catch(()=>{
    alert("Error publishing site.");
  });
}

/* =======================
   INSPECTOR TAB RENDER
======================= */
function renderInspectorTab(){
  const tab = activeInspectorTab;
  const el = document.getElementById("inspectorBody");
  if (!el) return;
  let html = "";
  if (tab === "page"){
    if (!current) {
      html = "<p>No page selected.</p>";
    } else {
      html += `<div class="field-group">
        <div class="field-label">Page Title</div>
        <input type="text" value="${escapeHtml(current.title)}" oninput="current.title=this.value;markDirty();updatePreviewHeader();">
      </div>
      <div class="field-group">
        <div class="field-label">Slug</div>
        <input type="text" value="${escapeHtml(current.slug)}" oninput="current.slug=this.value;markDirty();updatePreviewHeader();">
      </div>`;
    }
  }
  // ... [Continue inspector for hero, blocks, menu, site tabs] ...
  // For brevity, your original inspector rendering logic for these tabs continues here, unchanged.
  el.innerHTML = html;
}

/* =======================
   HELPERS
======================= */
function escapeHtml(str){
  return String(str||"").replace(/[&<>'"]/g, c=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'
  })[c]);
}

/* BUTTON HOOKS */
document.getElementById("publishBtn").onclick = publishToCloud;
document.getElementById("saveDraftBtn2").onclick = saveDraft;
document.getElementById("downloadBtn2").onclick = downloadJSON;
document.getElementById("backupBtn2").onclick = backupZip;

/* =======================
   END OF PART 4
======================= */
// (You may have extended inspector rendering for Hero, Blocks, Menu, Site. Example for Hero tab:)
if (activeInspectorTab === "hero" && current && current.hero) {
  let h = current.hero;
  el.innerHTML = `
    <div class="field-group">
      <div class="field-label">Hero Title</div>
      <input type="text" value="${escapeHtml(h.overlay)}" oninput="current.hero.overlay=this.value;markDirty();renderPreview();">
    </div>
    <div class="field-group">
      <div class="field-label">Subtitle</div>
      <input type="text" value="${escapeHtml(h.sub)}" oninput="current.hero.sub=this.value;markDirty();renderPreview();">
    </div>
    <div class="field-group">
      <div class="field-label">Hero Image URL</div>
      <input type="text" value="${escapeHtml(h.bg)}" oninput="current.hero.bg=this.value;markDirty();renderPreview();">
    </div>
    <div class="field-group">
      <div class="field-label">Size</div>
      <select onchange="current.hero.size=this.value;markDirty();renderPreview();">
        <option value="small"${h.size==='small'?' selected':''}>Small</option>
        <option value="medium"${h.size==='medium'?' selected':''}>Medium</option>
        <option value="large"${h.size==='large'?' selected':''}>Large</option>
        <option value="full"${h.size==='full'?' selected':''}>Full</option>
      </select>
    </div>
  `;
}
// (You can further extend for blocks, menu, site as your previous code did.)

/* =======================
   BLOCK HELPERS
======================= */
function addBlock(type){
  if (!current || !current.blocks) return;
  if (type==="heading") current.blocks.push({type:"heading",content:"Section Heading"});
  if (type==="paragraph") current.blocks.push({type:"paragraph",content:"Paragraph text here."});
  if (type==="image") current.blocks.push({type:"image",content:""});
  if (type==="button") current.blocks.push({type:"button",text:"Click me",url:"#"});
  if (type==="product") current.blocks.push({type:"product",title:"",text:"",image:"",url:""});
  if (type==="podcast") current.blocks.push({type:"podcast",title:"",embed:""});
  if (type==="youtube") current.blocks.push({type:"youtube",title:"",videoId:""});
  markDirty();
  renderPreview();
  renderInspectorTab();
}
function removeBlock(index){
  if (!current || !current.blocks) return;
  current.blocks.splice(index,1);
  markDirty();
  renderPreview();
  renderInspectorTab();
}
function moveBlock(index,delta){
  if (!current || !current.blocks) return;
  const blocks = current.blocks;
  const b = blocks.splice(index,1)[0];
  let newIndex = index+delta;
  if (newIndex < 0) newIndex = 0;
  if (newIndex > blocks.length) newIndex = blocks.length;
  blocks.splice(newIndex,0,b);
  markDirty();
  renderPreview();
  renderInspectorTab();
}

/* =======================
   UTILITIES
======================= */
// Example: function to update color themes, images, etc. Add as needed for your admin.

</script>
</body>
</html>














