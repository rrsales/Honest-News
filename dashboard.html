<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Honest News â€“ Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- LOGIN PROTECTION -->
<script>
  if (localStorage.getItem("hn_logged") !== "yes") {
    location.href = "admin.html";
  }
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
/* --- your exact CSS kept unchanged --- */

body{margin:0;font-family:system-ui,sans-serif;background:#f4f6f9;color:#1e293b;height:100vh;display:flex;flex-direction:column}
.header{background:#1e293b;color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:1.4rem;margin:0}
.header a{color:#94a3b8;text-decoration:none}
.main{flex:1;display:flex;overflow:hidden}
.sidebar{width:300px;background:#fff;border-right:1px solid #e2e8f0;padding:20px;overflow-y:auto}
.page{padding:15px;margin:10px 0;background:#f8fafc;border-radius:10px;cursor:pointer;font-weight:600}
.page.active{background:#4338ca;color:#fff}
.content{flex:1;padding:40px;overflow-y:auto}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:30px;margin-bottom:30px;box-shadow:0 4px 20px rgba(0,0,0,0.05)}
input,textarea,select{width:100%;padding:12px;margin:8px 0;border-radius:10px;border:1px solid #cbd5e1;font-size:15px}
button{background:#28a745;color:#fff;border:none;padding:12px 22px;border-radius:10px;cursor:pointer;font-weight:600}
button:hover{background:#218838}
.block{margin:16px 0;padding:16px;background:#f8fafc;border:2px dashed #cbd5e1;border-radius:12px;position:relative}
.block:hover{border-color:#28a745}
.tools{position:absolute;top:8px;right:8px;opacity:0;transition:0.2s}
.block:hover .tools{opacity:1}
.tools button{background:none;border:none;cursor:pointer;font-size:16px;margin:0 4px;color:#6366f1}
.preview{margin-top:30px;padding:30px;background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.1)}
label.inline{display:inline-flex;align-items:center;gap:.4rem;margin-right:1.2rem;font-size:.9rem}
small{color:#64748b}

.section{border-top:1px solid #e5e7eb;margin-top:10px;padding-top:10px}
.section-header{
  width:100%;background:none;border:none;display:flex;align-items:center;
  justify-content:space-between;font-size:0.98rem;padding:10px 0;cursor:pointer;
  color:#0f172a;
}
.section-header .left{display:flex;align-items:center;gap:.5rem}
.section-header .arrow{
  display:inline-block;transition:transform .25s ease,opacity .25s ease;
  font-size:0.85rem;color:#6b7280;
}
.section-header.open .arrow{transform:rotate(90deg);color:#111827}
.section-body{
  max-height:0;opacity:0;overflow:hidden;
  transform:translateY(-4px);
  transition:max-height .35s ease,opacity .25s ease,transform .35s ease;
}
.section-body.open{
  max-height:1200px;opacity:1;transform:translateY(0);
}
.section-body-inner{padding:4px 0 14px 0}

textarea{resize:vertical;min-height:80px}
</style>
</head>

<body>

<div class="header">
  <h1>Honest News â€“ Site Editor</h1>
  <a href="/" target="_blank">View Live Site â†’</a>
</div>

<div class="main">
  <div class="sidebar">
    <h3>Pages</h3>
    <div id="pages"></div>
    <button onclick="newPage()" style="width:100%;margin-top:20px">+ New Page</button>

    <h3 style="margin-top:30px">Navigation</h3>
    <small>Menu items (one per line): Title | URL</small>
    <textarea id="menuRaw" rows="6" oninput="menuFromRaw(this.value)"></textarea>
  </div>

  <div class="content" id="editor">
    <div class="card">
      <h2>Select a page to start editing</h2>
    </div>
  </div>
</div>

<script>
/* ------------------------------------------
   DATA MODEL â€” unchanged from your version
------------------------------------------- */

let site = {
  menu: [
    { title:"Home", url:"index.html" },
    { title:"Podcast", url:"podcast.html" },
    { title:"Shop", url:"shop.html" },
    { title:"Support", url:"support.html" },
    { title:"Contact", url:"contact.html" }
  ],
  pages: [
    {
      title:"Home",
      slug:"home",
      theme:"dark",
      hero:{
        bg:"https://images.unsplash.com/photo-1506905925346-21bda4d32df4?auto=format&fit=crop&w=1920&q=80",
        overlay:"Honest News Network",
        sub:"Everything You Need for Biblical Truth",
        transparentMenu:false,
        behavior:"parallax-medium",
        size:"full",
        customHeight:""
      },
      blocks:[]
    },
    {
      title:"Podcast",
      slug:"podcast",
      theme:"dark",
      hero:{
        bg:"",
        overlay:"Latest Episodes",
        sub:"New episodes every Sunday",
        transparentMenu:true,
        behavior:"parallax-slow",
        size:"full",
        customHeight:""
      },
      blocks:[]
    },
    {
      title:"Shop",
      slug:"shop",
      theme:"dark",
      hero:{
        bg:"",
        overlay:"Recommended Resources",
        sub:"Support your walk and support the ministry",
        transparentMenu:true,
        behavior:"still",
        size:"medium",
        customHeight:""
      },
      blocks:[]
    }
  ]
};

let current = null;

/* ------------------------------------------
   RESTORE DRAFT AUTOMATICALLY
------------------------------------------- */
const draft = localStorage.getItem("hn_draft");
if (draft) {
  try { site = JSON.parse(draft); }
  catch(e){ console.warn("Draft corrupted, ignoring."); }
}

/* ------------------------------------------
   MENUS + PAGES (unchanged from your version)
------------------------------------------- */

function rawFromMenu(){
  const t = site.menu.map(m=>`${m.title} | ${m.url}`).join("\n");
  document.getElementById("menuRaw").value = t;
}
function menuFromRaw(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  site.menu = lines.map(l=>{
    const [title,url] = l.split("|").map(s=>(s||"").trim());
    return {title:title||"Item",url:url||"#"};
  });
}

function renderPages(){
  document.getElementById("pages").innerHTML = site.pages.map((p,i)=>`
    <div class="page ${p===current?'active':''}" onclick="select(${i})">${p.title}</div>
  `).join("");
  if(!current) select(0);
  rawFromMenu();
}

/* ------------------------------------------
   ACCORDION TOGGLE
------------------------------------------- */
function toggleSection(id){
  const body = document.getElementById("section-"+id);
  const header = document.querySelector(`.section-header[data-section="${id}"]`);
  const isOpen = body.classList.contains("open");

  document.querySelectorAll(".section-body").forEach(b=>b.classList.remove("open"));
  document.querySelectorAll(".section-header").forEach(h=>h.classList.remove("open"));

  if(!isOpen){
    body.classList.add("open");
    header.classList.add("open");
  }
}

/* ------------------------------------------
   SELECT PAGE (your full logic preserved)
------------------------------------------- */
function select(i){
  current = site.pages[i];
  renderPageEditor();
  renderBlocks();
  preview();
}

/* ------------------------------------------
   PAGE EDITOR RENDERING
------------------------------------------- */
function renderPageEditor(){
  const c = current;

  document.getElementById("editor").innerHTML = `
    <div class="card">
      <h2>Editing: ${c.title}</h2>

      <!-- SAVE BUTTON -->
      <div style="margin:20px 0;">
        <button onclick="saveDraft()" 
          style="background:#0ea5e9;color:#fff;font-size:1.1rem;padding:14px 26px;border-radius:10px;border:none;cursor:pointer;">
          ðŸ’¾ Save Changes (Draft)
        </button>
      </div>

      <!-- PAGE SETTINGS -->
      <div class="section">
        <button class="section-header open" data-section="page" onclick="toggleSection('page')">
          <div class="left"><span class="arrow">â–¶</span><span class="section-title">Page Settings</span></div>
        </button>
        <div class="section-body open" id="section-page">
          <div class="section-body-inner">

            <div class="field-group">
              <div class="field-label">Page Title</div>
              <input value="${c.title}" onchange="current.title=this.value;renderPages()">
            </div>

            <div class="field-group">
              <div class="field-label">Slug</div>
              <input value="${c.slug}" onchange="current.slug=this.value">
            </div>

            <div class="field-group">
              <label class="inline"><input type="radio" name="theme" value="light" ${c.theme==="light"?"checked":""} onchange="current.theme='light';preview()"> Light</label>
              <label class="inline"><input type="radio" name="theme" value="dark" ${c.theme!=="light"?"checked":""} onchange="current.theme='dark';preview()"> Dark</label>
            </div>

          </div>
        </div>
      </div>

      <!-- HERO SETTINGS -->
      <div class="section">
        <button class="section-header" data-section="hero" onclick="toggleSection('hero')">
          <div class="left"><span class="arrow">â–¶</span><span class="section-title">Hero Settings</span></div>
        </button>
        <div class="section-body" id="section-hero">
          <div class="section-body-inner">

            <div class="field-group">
              <div class="field-label">Hero Image URL</div>
              <input value="${c.hero.bg}" onchange="current.hero.bg=this.value;preview()">
            </div>

            <div class="field-group">
              <div class="field-label">Main Title</div>
              <input value="${c.hero.overlay}" onchange="current.hero.overlay=this.value;preview()">
            </div>

            <div class="field-group">
              <div class="field-label">Subtitle</div>
              <input value="${c.hero.sub}" onchange="current.hero.sub=this.value;preview()">
            </div>

            <div class="field-group">
              <label class="inline">
                <input type="checkbox" ${c.hero.transparentMenu?"checked":""} onchange="current.hero.transparentMenu=this.checked;preview()">
                Transparent Menu
              </label>
            </div>

            <div class="field-group">
              <div class="field-label">Hero Behavior</div>
              <select onchange="current.hero.behavior=this.value;preview()">
                <option value="still">Still</option>
                <option value="parallax-slow">Parallax Slow</option>
                <option value="parallax-medium">Parallax Medium</option>
                <option value="float-up">Float Up</option>
              </select>
            </div>

            <div class="field-group">
              <div class="field-label">Hero Size</div>
              <label class="inline">
                <input type="radio" name="hero-size" value="small" ${c.hero.size==="small"?"checked":""} onchange="setHeroSize('small')"> Small
              </label>
              <label class="inline">
                <input type="radio" name="hero-size" value="medium" ${c.hero.size==="medium"?"checked":""} onchange="setHeroSize('medium')"> Medium
              </label>
              <label class="inline">
                <input type="radio" name="hero-size" value="large" ${c.hero.size==="large"?"checked":""} onchange="setHeroSize('large')"> Large
              </label>
              <label class="inline">
                <input type="radio" name="hero-size" value="full" ${c.hero.size==="full"?"checked":""} onchange="setHeroSize('full')"> Fullscreen
              </label>
              <label class="inline">
                <input type="radio" name="hero-size" value="custom" ${c.hero.size==="custom"?"checked":""} onchange="setHeroSize('custom')"> Custom
              </label>
              <input id="heroCustomHeight" value="${c.hero.customHeight}" placeholder="e.g. 520px" onchange="setHeroCustom(this.value)">
            </div>

          </div>
        </div>
      </div>

      <!-- CONTENT BLOCKS -->
      <div class="section">
        <button class="section-header" data-section="blocks" onclick="toggleSection('blocks')">
          <div class="left"><span class="arrow">â–¶</span><span class="section-title">Content Blocks</span></div>
        </button>
        <div class="section-body" id="section-blocks">
          <div class="section-body-inner">
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
              <button onclick="addBlock('heading')">+ Heading</button>
              <button onclick="addBlock('paragraph')">+ Paragraph</button>
              <button onclick="addBlock('image')">+ Image</button>
              <button onclick="addBlock('button')">+ Button</button>
              <button onclick="addBlock('product')">+ Product</button>
              <button onclick="addBlock('podcast')">+ Podcast</button>
              <button onclick="addBlock('youtube')">+ YouTube</button>
            </div>

            <div id="blocks"></div>
          </div>
        </div>
      </div>

      <!-- PUBLISH -->
      <div class="section">
        <button class="section-header" data-section="publish" onclick="toggleSection('publish')">
          <div class="left"><span class="arrow">â–¶</span><span class="section-title">Publish & Backup</span></div>
        </button>
        <div class="section-body" id="section-publish">
          <div class="section-body-inner">
            <button onclick="publish()" style="background:#16a34a">Download site-data.json</button>
            <button onclick="backupAll()" style="background:#0f172a;margin-left:10px">Full Backup (.zip)</button>
          </div>
        </div>
      </div>

      <!-- PREVIEW -->
      <div class="preview">
        <h3>Live Preview</h3>
        <div id="heroPreview" style="background:url(${c.hero.bg}) center/cover;height:300px;border-radius:14px;"></div>
        <div id="blockPreview" style="padding:24px"></div>
      </div>

    </div>
  `;
}

/* ------------------------------------------
   HERO HELPERS
------------------------------------------- */
function setHeroSize(size){
  current.hero.size = size;
  preview();
}
function setHeroCustom(val){
  current.hero.size = "custom";
  current.hero.customHeight = val;
  preview();
}

/* ------------------------------------------
   BLOCK SYSTEM (same as before)
------------------------------------------- */

function addBlock(type){
  const b = { type, motion:"fade" };
  if(type==="heading") b.content="New Heading";
  if(type==="paragraph") b.content="Paragraph text";
  if(type==="image") { b.content="" }
  if(type==="button"){ b.text="Click me"; b.url="#" }
  if(type==="product"){ b.title="Product"; b.text="Description"; b.image=""; b.url="" }
  if(type==="podcast"){ b.title="Episode title"; b.embed="" }
  if(type==="youtube"){ b.title="Video title"; b.videoId="" }

  current.blocks.push(b);
  renderBlocks();
  preview();
}

function renderBlocks(){
  const c = document.getElementById("blocks");
  c.innerHTML = current.blocks.map((b,i)=>`
    <div class="block">
      <div class="block-type-label">
        Type: ${b.type.toUpperCase()}
      </div>

      ${b.type==="heading" ? `<input value="${b.content}" onchange="current.blocks[${i}].content=this.value;preview()">` : ""}
      ${b.type==="paragraph" ? `<textarea onchange="current.blocks[${i}].content=this.value;preview()">${b.content}</textarea>` : ""}
      ${b.type==="image" ? `<input value="${b.content}" onchange="current.blocks[${i}].content=this.value;preview()" placeholder="Image URL">` : ""}
      ${b.type==="button" ? `
          <input value="${b.text}" onchange="current.blocks[${i}].text=this.value;preview()">
          <input value="${b.url}" onchange="current.blocks[${i}].url=this.value;preview()">
      ` : ""}
      ${b.type==="product" ? `
          <input value="${b.title}" onchange="current.blocks[${i}].title=this.value;preview()">
          <textarea onchange="current.blocks[${i}].text=this.value;preview()">${b.text}</textarea>
          <input value="${b.image}" onchange="current.blocks[${i}].image=this.value;preview()">
          <input value="${b.url}" onchange="current.blocks[${i}].url=this.value;preview()">
      ` : ""}
      ${b.type==="podcast" ? `
          <input value="${b.title}" onchange="current.blocks[${i}].title=this.value;preview()">
          <textarea onchange="current.blocks[${i}].embed=this.value;preview()">${b.embed}</textarea>
      ` : ""}
      ${b.type==="youtube" ? `
          <input value="${b.title}" onchange="current.blocks[${i}].title=this.value;preview()">
          <input value="${b.videoId}" onchange="current.blocks[${i}].videoId=this.value;preview()">
      ` : ""}

      <div class="tools">
        <button onclick="move(${i},-1)">â†‘</button>
        <button onclick="move(${i},1)">â†“</button>
        <button onclick="removeBlock(${i})">Ã—</button>
      </div>
    </div>
  `).join("");
}

/* ------------------------------------------
   BLOCK MOVEMENT
------------------------------------------- */
function move(i,d){
  const b=current.blocks.splice(i,1)[0];
  current.blocks.splice(i+d,0,b);
  renderBlocks();
  preview();
}
function removeBlock(i){
  current.blocks.splice(i,1);
  renderBlocks();
  preview();
}

/* ------------------------------------------
   PREVIEW
------------------------------------------- */
function preview(){
  const c = current;
  const hero = document.getElementById("heroPreview");

  let h = "300px";
  if(c.hero.size==="small") h="40vh";
  if(c.hero.size==="medium") h="60vh";
  if(c.hero.size==="large") h="80vh";
  if(c.hero.size==="full") h="100vh";
  if(c.hero.size==="custom" && c.hero.customHeight) h=c.hero.customHeight;

  hero.style.height = h;
  hero.style.backgroundImage = `url('${c.hero.bg}')`;

  let html = "";
  c.blocks.forEach(b=>{
    if(b.type==="heading") html+=`<h2>${b.content}</h2>`;
    if(b.type==="paragraph") html+=`<p>${b.content.replace(/\n/g,"<br>")}</p>`;
    if(b.type==="image") html+=`<img src="${b.content}" style="max-width:100%;border-radius:10px;margin:1rem 0;">`;
    if(b.type==="button") html+=`<a href="${b.url}" style="background:#28a745;color:white;padding:12px 24px;border-radius:999px;text-decoration:none;display:inline-block;margin:1rem 0;">${b.text}</a>`;
    if(b.type==="product") html+=`
      <div style="background:#111827;padding:1rem;border-radius:12px;margin:1rem 0;">
        <h3>${b.title}</h3>
        <p>${b.text}</p>
        <img src="${b.image}" style="max-width:150px;border-radius:8px;"><br>
        <a href="${b.url}" target="_blank" style="background:#4ade80;color:black;padding:8px 16px;border-radius:999px;text-decoration:none;margin-top:8px;display:inline-block;">Buy on Amazon</a>
      </div>`;
    if(b.type==="podcast") html+=`
      <div style="margin:1rem 0;">
        <h3>${b.title}</h3>
        <iframe src="${b.embed}" style="width:100%;height:160px;border:none;"></iframe>
      </div>`;
    if(b.type==="youtube"){
      let id=b.videoId;
      const m=id.match(/v=([^&]+)/); if(m) id=m[1];
      html+=`
        <div style="margin:1rem 0;">
          <h3>${b.title}</h3>
          <iframe src="https://www.youtube.com/embed/${id}" style="width:100%;height:300px;border:none;border-radius:12px;"></iframe>
        </div>`;
    }
  });

  document.getElementById("blockPreview").innerHTML = html;
}

/* ------------------------------------------
   SAVE DRAFT  (the new feature)
------------------------------------------- */
function saveDraft(){
  localStorage.setItem("hn_draft", JSON.stringify(site));
  alert("Draft saved!");
}

/* ------------------------------------------
   PUBLISH JSON
------------------------------------------- */
function publish(){
  const blob = new Blob([JSON.stringify(site,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "site-data.json";
  a.click();
}

/* ------------------------------------------
   BACKUP ZIP
------------------------------------------- */
async function backupAll(){
  const zip = new JSZip();
  zip.file("site-data.json", JSON.stringify(site,null,2));

  const list = [
    "index.html","podcast.html","shop.html",
    "contact.html","admin.html","dashboard.html","live.js"
  ];

  for(const f of list){
    try{
      const res = await fetch(f);
      if(res.ok) zip.file(f, await res.text());
    }catch(e){}
  }

  const blob = await zip.generateAsync({type:"blob"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="honest-news-full-backup.zip";
  a.click();
}

/* INIT */
renderPages();
</script>
</body>
</html>
